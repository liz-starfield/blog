<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.0" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.13" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="alternate" hreflang="en-us" href="https://liz-starfield.github.io/blog/posts/LLM/transformer.html"><meta property="og:url" content="https://liz-starfield.github.io/blog/zh/posts/LLM/transformer.html"><meta property="og:site_name" content="è‰èŠ"><meta property="og:title" content="Transformeræºç è§£è¯»"><meta property="og:description" content="Transformeræºç è§£è¯» About æ¨¡å‹æ€»ä½“æ¶æ„ è¶…å‚æ•° å¼ é‡ç»´åº¦è½¬æ¢ å¯è®­ç»ƒå‚æ•°é‡ æºç "><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:locale:alternate" content="en-US"><meta property="og:updated_time" content="2024-06-03T01:33:06.000Z"><meta property="article:author" content="Liz"><meta property="article:tag" content="LLM"><meta property="article:published_time" content="2024-05-24T00:00:00.000Z"><meta property="article:modified_time" content="2024-06-03T01:33:06.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Transformeræºç è§£è¯»","image":[""],"datePublished":"2024-05-24T00:00:00.000Z","dateModified":"2024-06-03T01:33:06.000Z","author":[{"@type":"Person","name":"Liz","url":"https://github.com/liz-starfield"}]}</script><link rel="icon" herf="/blogger.png"><link rel="icon" href="/blog/blogger.png"><title>Transformeræºç è§£è¯» | è‰èŠ</title><meta name="description" content="Transformeræºç è§£è¯» About æ¨¡å‹æ€»ä½“æ¶æ„ è¶…å‚æ•° å¼ é‡ç»´åº¦è½¬æ¢ å¯è®­ç»ƒå‚æ•°é‡ æºç ">
    <link rel="preload" href="/blog/assets/style-7GABgOoK.css" as="style"><link rel="stylesheet" href="/blog/assets/style-7GABgOoK.css">
    <link rel="modulepreload" href="/blog/assets/app-qHU6L02m.js"><link rel="modulepreload" href="/blog/assets/transformer.html-YfxXjngT.js"><link rel="modulepreload" href="/blog/assets/transformer.html-fHjOv48j.js"><link rel="modulepreload" href="/blog/assets/plugin-vue_export-helper-x3n3nnut.js">
    <link rel="prefetch" href="/blog/assets/index.html-LFD91XO_.js" as="script"><link rel="prefetch" href="/blog/assets/intro.html-E6FIGQFr.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-8pZ41A_w.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-PxUfOlrM.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-s_datAw3.js" as="script"><link rel="prefetch" href="/blog/assets/intro.html-3kAZxSDz.js" as="script"><link rel="prefetch" href="/blog/assets/careers.html-2YAb7m8X.js" as="script"><link rel="prefetch" href="/blog/assets/communication.html-T68lRBW_.js" as="script"><link rel="prefetch" href="/blog/assets/computers.html-ve4rOIVZ.js" as="script"><link rel="prefetch" href="/blog/assets/describing_something.html-8VjhUkmx.js" as="script"><link rel="prefetch" href="/blog/assets/dreams.html-lfx3_joE.js" as="script"><link rel="prefetch" href="/blog/assets/feelings.html-JZzQmHxo.js" as="script"><link rel="prefetch" href="/blog/assets/graduating.html-mdxyICER.js" as="script"><link rel="prefetch" href="/blog/assets/grammar.html-8Q9YJc8K.js" as="script"><link rel="prefetch" href="/blog/assets/greetings.html-FPO73DtD.js" as="script"><link rel="prefetch" href="/blog/assets/hobbies.html-IwAofZph.js" as="script"><link rel="prefetch" href="/blog/assets/immigration.html-ph07V6IZ.js" as="script"><link rel="prefetch" href="/blog/assets/introducing_someone.html--zYgm4q2.js" as="script"><link rel="prefetch" href="/blog/assets/phone.html-PBoULsJ3.js" as="script"><link rel="prefetch" href="/blog/assets/pronunciation.html-g3TyM_sS.js" as="script"><link rel="prefetch" href="/blog/assets/time.html-6vml1xp0.js" as="script"><link rel="prefetch" href="/blog/assets/traits.html-C2L_-Hiv.js" as="script"><link rel="prefetch" href="/blog/assets/langchain.html-zKUtrlMr.js" as="script"><link rel="prefetch" href="/blog/assets/langchain_source_code.html-hLzF0c4R.js" as="script"><link rel="prefetch" href="/blog/assets/llama.html-k3uDI0u6.js" as="script"><link rel="prefetch" href="/blog/assets/llm_summary.html-cvktnuJX.js" as="script"><link rel="prefetch" href="/blog/assets/streamlit.html-EoCnwOlO.js" as="script"><link rel="prefetch" href="/blog/assets/transformer.html-tE9tDwxy.js" as="script"><link rel="prefetch" href="/blog/assets/01_python_environment.html-5fJs1XZK.js" as="script"><link rel="prefetch" href="/blog/assets/02_python_data_type.html-HK52Z0IM.js" as="script"><link rel="prefetch" href="/blog/assets/03_python_operator.html-9_6xioiS.js" as="script"><link rel="prefetch" href="/blog/assets/04_python_method.html-IrOHK25K.js" as="script"><link rel="prefetch" href="/blog/assets/05_python_builtin_module.html-XlhXg8tm.js" as="script"><link rel="prefetch" href="/blog/assets/06_python_popular_package.html-6--ZbeB9.js" as="script"><link rel="prefetch" href="/blog/assets/01_ai_concept.html-1dsmjxhQ.js" as="script"><link rel="prefetch" href="/blog/assets/02_neural_net_train.html-MX0ksQLN.js" as="script"><link rel="prefetch" href="/blog/assets/03_pytorch_operation.html-eCRdWA85.js" as="script"><link rel="prefetch" href="/blog/assets/04_pytorch_practice_nn.html-k-oRm6yz.js" as="script"><link rel="prefetch" href="/blog/assets/05_linear_nn.html-m_m1sUSe.js" as="script"><link rel="prefetch" href="/blog/assets/06_heterogeneous_graph.html-QSneYC4l.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-f_nlM_7J.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-ZYhhb8JE.js" as="script"><link rel="prefetch" href="/blog/assets/langchain.html-SCmjtC1i.js" as="script"><link rel="prefetch" href="/blog/assets/langchain_source_code.html-z5i49H-V.js" as="script"><link rel="prefetch" href="/blog/assets/llama.html-46p_1T-q.js" as="script"><link rel="prefetch" href="/blog/assets/llm_summary.html-3pu0Iumg.js" as="script"><link rel="prefetch" href="/blog/assets/streamlit.html-iUfqazN1.js" as="script"><link rel="prefetch" href="/blog/assets/01_python_environment.html-6W1uTEtk.js" as="script"><link rel="prefetch" href="/blog/assets/02_python_data_type.html-m1bRXT1E.js" as="script"><link rel="prefetch" href="/blog/assets/03_python_operator.html-ZpTatogN.js" as="script"><link rel="prefetch" href="/blog/assets/04_python_method.html-RoP1I2kq.js" as="script"><link rel="prefetch" href="/blog/assets/05_python_builtin_module.html-H8OsYbTz.js" as="script"><link rel="prefetch" href="/blog/assets/06_python_popular_package.html-D_hwoRQE.js" as="script"><link rel="prefetch" href="/blog/assets/01_ai_concept.html-sQ3f7eMA.js" as="script"><link rel="prefetch" href="/blog/assets/02_neural_net_train.html-ANQdT1B0.js" as="script"><link rel="prefetch" href="/blog/assets/03_pytorch_operation.html-YMujwhKY.js" as="script"><link rel="prefetch" href="/blog/assets/04_pytorch_practice_nn.html-QQ109Ack.js" as="script"><link rel="prefetch" href="/blog/assets/05_linear_nn.html-vHRH7ymp.js" as="script"><link rel="prefetch" href="/blog/assets/06_heterogeneous_graph.html-50Tvq9Km.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-_gRo7Dcd.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-cKTGnjrW.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-UxATL_0T.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Mv3ej2IF.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-hZU6eHY7.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-kJ320kxl.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-PCaJfeIo.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-EqHBUaBn.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-VOr9nBXB.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-lMZf9nw6.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-8E67PwBh.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-qostYW_M.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-T-uPJpYq.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-fwy4Lfih.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-a5YkJeQn.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-bys25b8k.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-NSZidhQD.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-sh1juioO.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-VpAiyB26.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Qi9078Dh.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-ZDxccGry.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-T-9GN81B.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Kzol0OIK.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-9t8BxIqc.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-4rWeg-rw.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-c5Din3Gd.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-SVlXYkho.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-u6ZwE8BE.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-gikpHa9b.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CsjM6MnY.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-yX1j37_q.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-gUmwP0GA.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-fdx6_zlO.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-7pNQOk23.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-8dBZSIkT.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Ohri_95T.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-uJ4nU7QG.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-MRcbvmhe.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-p-WoYfCM.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-hTrRFZkT.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-67j3W8G7.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-m34kEvDY.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-m0dv9t6y.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-dxLqYysi.js" as="script"><link rel="prefetch" href="/blog/assets/index.html--IEIJJE7.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-YVQ3Gxv8.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-qnPGVL8b.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-1Sw7IP1J.js" as="script"><link rel="prefetch" href="/blog/assets/intro.html-YuRAlYdc.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-kHrP8ahI.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DkmcnAub.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-7HAytPQR.js" as="script"><link rel="prefetch" href="/blog/assets/intro.html-2M7WMqUC.js" as="script"><link rel="prefetch" href="/blog/assets/careers.html-YsTnTk4G.js" as="script"><link rel="prefetch" href="/blog/assets/communication.html-FUAqB3jk.js" as="script"><link rel="prefetch" href="/blog/assets/computers.html-HoHVc3Ej.js" as="script"><link rel="prefetch" href="/blog/assets/describing_something.html-BkQ-lZxo.js" as="script"><link rel="prefetch" href="/blog/assets/dreams.html-xxWYXDVl.js" as="script"><link rel="prefetch" href="/blog/assets/feelings.html-pwkguZdf.js" as="script"><link rel="prefetch" href="/blog/assets/graduating.html-AzRcrTvS.js" as="script"><link rel="prefetch" href="/blog/assets/grammar.html-haYSTjNe.js" as="script"><link rel="prefetch" href="/blog/assets/greetings.html-Y4FRHMcv.js" as="script"><link rel="prefetch" href="/blog/assets/hobbies.html-iJDIuCig.js" as="script"><link rel="prefetch" href="/blog/assets/immigration.html-epeMm5wz.js" as="script"><link rel="prefetch" href="/blog/assets/introducing_someone.html-WCxzGed-.js" as="script"><link rel="prefetch" href="/blog/assets/phone.html-3bcnmsFc.js" as="script"><link rel="prefetch" href="/blog/assets/pronunciation.html-Ra29fUpy.js" as="script"><link rel="prefetch" href="/blog/assets/time.html-yaO-I8lP.js" as="script"><link rel="prefetch" href="/blog/assets/traits.html-Y-5Omn5e.js" as="script"><link rel="prefetch" href="/blog/assets/langchain.html-RPYmjkWV.js" as="script"><link rel="prefetch" href="/blog/assets/langchain_source_code.html-UhWsiH_S.js" as="script"><link rel="prefetch" href="/blog/assets/llama.html-KVunzNB7.js" as="script"><link rel="prefetch" href="/blog/assets/llm_summary.html-VMWfBMzx.js" as="script"><link rel="prefetch" href="/blog/assets/streamlit.html-4aQtBExM.js" as="script"><link rel="prefetch" href="/blog/assets/transformer.html-Jw3t-rSz.js" as="script"><link rel="prefetch" href="/blog/assets/01_python_environment.html-iqmklEkM.js" as="script"><link rel="prefetch" href="/blog/assets/02_python_data_type.html-0-zhs9_v.js" as="script"><link rel="prefetch" href="/blog/assets/03_python_operator.html-ud0ymCAP.js" as="script"><link rel="prefetch" href="/blog/assets/04_python_method.html-bfoJwsjL.js" as="script"><link rel="prefetch" href="/blog/assets/05_python_builtin_module.html--5xPle-9.js" as="script"><link rel="prefetch" href="/blog/assets/06_python_popular_package.html-yObnfHTg.js" as="script"><link rel="prefetch" href="/blog/assets/01_ai_concept.html-BxDBm9Sk.js" as="script"><link rel="prefetch" href="/blog/assets/02_neural_net_train.html-H1YAL137.js" as="script"><link rel="prefetch" href="/blog/assets/03_pytorch_operation.html-J6H7PWpq.js" as="script"><link rel="prefetch" href="/blog/assets/04_pytorch_practice_nn.html-Us1zn4yN.js" as="script"><link rel="prefetch" href="/blog/assets/05_linear_nn.html-RLmj-OWb.js" as="script"><link rel="prefetch" href="/blog/assets/06_heterogeneous_graph.html-pm-XErLG.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Ar19wABq.js" as="script"><link rel="prefetch" href="/blog/assets/index.html--kwu7ARA.js" as="script"><link rel="prefetch" href="/blog/assets/langchain.html-NUmslhNT.js" as="script"><link rel="prefetch" href="/blog/assets/langchain_source_code.html-G5vf2sc-.js" as="script"><link rel="prefetch" href="/blog/assets/llama.html-J3i7ma3t.js" as="script"><link rel="prefetch" href="/blog/assets/llm_summary.html-LS6nCcu1.js" as="script"><link rel="prefetch" href="/blog/assets/streamlit.html-S01-i3A4.js" as="script"><link rel="prefetch" href="/blog/assets/01_python_environment.html-BCJVDN1u.js" as="script"><link rel="prefetch" href="/blog/assets/02_python_data_type.html-ipxtQSfn.js" as="script"><link rel="prefetch" href="/blog/assets/03_python_operator.html-s57iqX96.js" as="script"><link rel="prefetch" href="/blog/assets/04_python_method.html-i4VMAy4d.js" as="script"><link rel="prefetch" href="/blog/assets/05_python_builtin_module.html-2uWT1Els.js" as="script"><link rel="prefetch" href="/blog/assets/06_python_popular_package.html-nmh7l7HJ.js" as="script"><link rel="prefetch" href="/blog/assets/01_ai_concept.html-p_r_5sYk.js" as="script"><link rel="prefetch" href="/blog/assets/02_neural_net_train.html-eVFqZk94.js" as="script"><link rel="prefetch" href="/blog/assets/03_pytorch_operation.html-QGHbYLw2.js" as="script"><link rel="prefetch" href="/blog/assets/04_pytorch_practice_nn.html-t51xQxrF.js" as="script"><link rel="prefetch" href="/blog/assets/05_linear_nn.html-G251Wlxb.js" as="script"><link rel="prefetch" href="/blog/assets/06_heterogeneous_graph.html-vLtgHBw2.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-pvGu8h5n.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-quxbGR5w.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-lhmT0nTS.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-QR9oEBro.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-D3ZLIyyw.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-5hjIgMHX.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-YPgZ-dP7.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-J8aOSoT9.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-oee1B7hc.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-VSDe3w5M.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-vGZVk05f.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-VviL8v8A.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-EXPGo8Gc.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-RFRwNCdD.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-1Bir_nxy.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-ROqbpC2K.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Y3coqdBJ.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DUpULbCY.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-nlG68x1j.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-AYgL90Cz.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-gKDcUkU-.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-6UKyMKhr.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-fRuIIPYA.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-T3wlVMOi.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-EXvPFa63.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-fYCe1WU1.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-7-bckT14.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Z-JlwkfN.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Pm2VNL42.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-lJ0G5hJZ.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-uMDAySCw.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-eqL39hpT.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-iqgLrZy6.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-iL30XFkC.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-OdehsU09.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-1V_T_Axe.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-w3ra5Ucp.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-mjqz4Uzs.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-0dfaRBmh.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-0svnN0Mr.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-gYopd1Ae.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-VIMbPS_u.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-IBpQD0am.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-GAFdG-Tf.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Z2359kMF.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-NZZmI3jd.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-T8I80md6.js" as="script"><link rel="prefetch" href="/blog/assets/photoswipe.esm-08_zHRDQ.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="vp-link vp-brand vp-brand" href="/blog/zh/"><img class="vp-nav-logo" src="/blog/blogger.png" alt><!----><span class="vp-site-name hide-in-pad">è‰èŠ</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a aria-label="é¦–é¡µ" class="vp-link nav-link nav-link" href="/blog/zh/"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>é¦–é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="åšå®¢" class="vp-link nav-link active nav-link active" href="/blog/zh/posts/"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span>åšå®¢<!----></a></div><div class="nav-item hide-in-mobile"><a aria-label="é¡¹ç›®" class="vp-link nav-link nav-link" href="/blog/zh/demo/"><span class="font-icon icon fa-fw fa-sm fas fa-star" style=""></span>é¡¹ç›®<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><div class="nav-item"><div class="dropdown-wrapper i18n-dropdown"><button type="button" class="dropdown-title" aria-label="é€‰æ‹©è¯­è¨€"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon i18n-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="i18n icon" style="width:1rem;height:1rem;vertical-align:middle;"><path d="M379.392 460.8 494.08 575.488l-42.496 102.4L307.2 532.48 138.24 701.44l-71.68-72.704L234.496 460.8l-45.056-45.056c-27.136-27.136-51.2-66.56-66.56-108.544h112.64c7.68 14.336 16.896 27.136 26.112 35.84l45.568 46.08 45.056-45.056C382.976 312.32 409.6 247.808 409.6 204.8H0V102.4h256V0h102.4v102.4h256v102.4H512c0 70.144-37.888 161.28-87.04 210.944L378.88 460.8zM576 870.4 512 1024H409.6l256-614.4H768l256 614.4H921.6l-64-153.6H576zM618.496 768h196.608L716.8 532.48 618.496 768z"></path></svg><!--]--><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a aria-label="English" class="vp-link nav-link nav-link" href="/blog/posts/LLM/transformer.html"><!---->English<!----></a></li><li class="dropdown-item"><a aria-label="ç®€ä½“ä¸­æ–‡" class="vp-link nav-link active nav-link active" href="/blog/zh/posts/LLM/transformer.html"><!---->ç®€ä½“ä¸­æ–‡<!----></a></li></ul></button></div></div><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/liz-starfield" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><!--[--><a aria-label="é¦–é¡µ" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/zh/"><span class="font-icon icon fa-fw fa-sm fas fa-home" style=""></span>é¦–é¡µ<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="å…³äºæˆ‘" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/zh/intro.html"><span class="font-icon icon fa-fw fa-sm fas fa-user" style=""></span>å…³äºæˆ‘<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><section class="vp-sidebar-group"><p class="vp-sidebar-heading active"><span class="font-icon icon fa-fw fa-sm fas fa-book" style=""></span><span class="vp-sidebar-title">åšå®¢</span><!----></p><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><!----><span class="vp-sidebar-title">L L M</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><!--[--><a aria-label="ä¸€æ–‡å¸¦ä½ äº†è§£LangChain: ä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹æ„å»ºå¼ºå¤§çš„åº”ç”¨ç¨‹åº" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/zh/posts/LLM/langchain.html"><span class="font-icon icon fa-fw fa-sm fas fa-lightbulb" style=""></span>ä¸€æ–‡å¸¦ä½ äº†è§£LangChain: ä½¿ç”¨å¤§è¯­è¨€æ¨¡å‹æ„å»ºå¼ºå¤§çš„åº”ç”¨ç¨‹åº<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="ä»æºç è§†è§’ï¼Œçª¥æ¢LangChainçš„è¿è¡Œé€»è¾‘" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/zh/posts/LLM/langchain_source_code.html"><span class="font-icon icon fa-fw fa-sm fas fa-lightbulb" style=""></span>ä»æºç è§†è§’ï¼Œçª¥æ¢LangChainçš„è¿è¡Œé€»è¾‘<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="streamlitæ„å»ºå¯¹è¯å¼åº”ç”¨ç¨‹åº" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/zh/posts/LLM/streamlit.html"><span class="font-icon icon fa-fw fa-sm fas fa-lightbulb" style=""></span>streamlitæ„å»ºå¯¹è¯å¼åº”ç”¨ç¨‹åº<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="Transformeræºç è§£è¯»" class="vp-link nav-link active vp-sidebar-link vp-sidebar-page active nav-link active vp-sidebar-link vp-sidebar-page active" href="/blog/zh/posts/LLM/transformer.html"><span class="font-icon icon fa-fw fa-sm fas fa-lightbulb" style=""></span>Transformeræºç è§£è¯»<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="1. About" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_1-about"><!---->1. About<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="2. æ¨¡å‹æ€»ä½“æ¶æ„" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_2-æ¨¡å‹æ€»ä½“æ¶æ„"><!---->2. æ¨¡å‹æ€»ä½“æ¶æ„<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="3. è¶…å‚æ•°" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_3-è¶…å‚æ•°"><!---->3. è¶…å‚æ•°<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="4. å¼ é‡ç»´åº¦è½¬æ¢" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_4-å¼ é‡ç»´åº¦è½¬æ¢"><!---->4. å¼ é‡ç»´åº¦è½¬æ¢<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5. å¯è®­ç»ƒå‚æ•°é‡" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_5-å¯è®­ç»ƒå‚æ•°é‡"><!---->5. å¯è®­ç»ƒå‚æ•°é‡<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="5.1. MultiHeadedAttention" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_5-1-multiheadedattention"><!---->5.1. MultiHeadedAttention<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.2. PositionwiseFeedForward" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_5-2-positionwisefeedforward"><!---->5.2. PositionwiseFeedForward<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.3. LayerNorm" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_5-3-layernorm"><!---->5.3. LayerNorm<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.4. Embeddings" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_5-4-embeddings"><!---->5.4. Embeddings<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="5.5. æ€»çš„å¯è®­ç»ƒå‚æ•°é‡" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_5-5-æ€»çš„å¯è®­ç»ƒå‚æ•°é‡"><!---->5.5. æ€»çš„å¯è®­ç»ƒå‚æ•°é‡<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6. æºç " class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_6-æºç "><!---->6. æºç <!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a aria-label="6.1. å®Œæ•´æ¨¡å‹" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_6-1-å®Œæ•´æ¨¡å‹"><!---->6.1. å®Œæ•´æ¨¡å‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6.2. EncoderDecoderï¼ˆç¼–ç å™¨-è§£ç å™¨ç»“æ„ï¼‰" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_6-2-encoderdecoder-ç¼–ç å™¨-è§£ç å™¨ç»“æ„"><!---->6.2. EncoderDecoderï¼ˆç¼–ç å™¨-è§£ç å™¨ç»“æ„ï¼‰<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6.3. Encoderï¼ˆç¼–ç å™¨ï¼‰" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_6-3-encoder-ç¼–ç å™¨"><!---->6.3. Encoderï¼ˆç¼–ç å™¨ï¼‰<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6.4. Decoderï¼ˆè§£ç å™¨ï¼‰" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_6-4-decoder-è§£ç å™¨"><!---->6.4. Decoderï¼ˆè§£ç å™¨ï¼‰<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6.5. MultiHeadedAttentionï¼ˆå¤šå¤´æ³¨æ„åŠ›ï¼‰" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_6-5-multiheadedattention-å¤šå¤´æ³¨æ„åŠ›"><!---->6.5. MultiHeadedAttentionï¼ˆå¤šå¤´æ³¨æ„åŠ›ï¼‰<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6.6. PositionwiseFeedForwardï¼ˆåŸºäºä½ç½®çš„å‰é¦ˆç½‘ç»œï¼‰" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_6-6-positionwisefeedforward-åŸºäºä½ç½®çš„å‰é¦ˆç½‘ç»œ"><!---->6.6. PositionwiseFeedForwardï¼ˆåŸºäºä½ç½®çš„å‰é¦ˆç½‘ç»œï¼‰<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6.7. Embeddingsï¼ˆåµŒå…¥å±‚ï¼‰" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_6-7-embeddings-åµŒå…¥å±‚"><!---->6.7. Embeddingsï¼ˆåµŒå…¥å±‚ï¼‰<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6.8. PositionalEncodingï¼ˆä½ç½®ç¼–ç ï¼‰" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_6-8-positionalencoding-ä½ç½®ç¼–ç "><!---->6.8. PositionalEncodingï¼ˆä½ç½®ç¼–ç ï¼‰<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6.9. Generatorï¼ˆç”Ÿæˆå™¨ï¼‰" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_6-9-generator-ç”Ÿæˆå™¨"><!---->6.9. Generatorï¼ˆç”Ÿæˆå™¨ï¼‰<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6.10. clonesï¼ˆå…‹éš†ï¼‰" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_6-10-clones-å…‹éš†"><!---->6.10. clonesï¼ˆå…‹éš†ï¼‰<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6.11. LayerNormï¼ˆå±‚å½’ä¸€åŒ–ï¼‰" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_6-11-layernorm-å±‚å½’ä¸€åŒ–"><!---->6.11. LayerNormï¼ˆå±‚å½’ä¸€åŒ–ï¼‰<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6.12. SublayerConnectionï¼ˆå­å±‚è¿æ¥ï¼‰" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_6-12-sublayerconnection-å­å±‚è¿æ¥"><!---->6.12. SublayerConnectionï¼ˆå­å±‚è¿æ¥ï¼‰<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a aria-label="6.13. æ¨¡å‹ä½¿ç”¨çš„ä¾‹å­" class="vp-link nav-link vp-sidebar-link vp-heading nav-link vp-sidebar-link vp-heading" href="/blog/zh/posts/LLM/transformer.html#_6-13-æ¨¡å‹ä½¿ç”¨çš„ä¾‹å­"><!---->6.13. æ¨¡å‹ä½¿ç”¨çš„ä¾‹å­<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li></ul><!--]--></li><li><!--[--><a aria-label="Llamaæºç è§£è¯»" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/zh/posts/LLM/llama.html"><span class="font-icon icon fa-fw fa-sm fas fa-lightbulb" style=""></span>Llamaæºç è§£è¯»<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-label="LLMæ±‡æ€»" class="vp-link nav-link vp-sidebar-link vp-sidebar-page nav-link vp-sidebar-link vp-sidebar-page" href="/blog/zh/posts/LLM/llm_summary.html"><span class="font-icon icon fa-fw fa-sm fas fa-lightbulb" style=""></span>LLMæ±‡æ€»<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Python</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><!----><span class="vp-sidebar-title">Pytorch</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><span class="font-icon icon fa-fw fa-sm fas fa-lightbulb" style=""></span>Transformeræºç è§£è¯»</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://github.com/liz-starfield" target="_blank" rel="noopener noreferrer">Liz</a></span><span property="author" content="Liz"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-05-24T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 24 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT24M"></span><span class="page-category-info" aria-label="åˆ†ç±»ğŸŒˆ" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category6 clickable" role="navigation">LLM</span><!--]--><meta property="articleSection" content="LLM"></span><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item tag6 clickable" role="navigation">LLM</span><!--]--><meta property="keywords" content="LLM"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#_1-about">1. About</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#_2-æ¨¡å‹æ€»ä½“æ¶æ„">2. æ¨¡å‹æ€»ä½“æ¶æ„</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#_3-è¶…å‚æ•°">3. è¶…å‚æ•°</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#_4-å¼ é‡ç»´åº¦è½¬æ¢">4. å¼ é‡ç»´åº¦è½¬æ¢</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#_5-å¯è®­ç»ƒå‚æ•°é‡">5. å¯è®­ç»ƒå‚æ•°é‡</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-1-multiheadedattention">5.1. MultiHeadedAttention</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-2-positionwisefeedforward">5.2. PositionwiseFeedForward</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-3-layernorm">5.3. LayerNorm</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-4-embeddings">5.4. Embeddings</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_5-5-æ€»çš„å¯è®­ç»ƒå‚æ•°é‡">5.5. æ€»çš„å¯è®­ç»ƒå‚æ•°é‡</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level2 toc-link level2" href="#_6-æºç ">6. æºç </a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-1-å®Œæ•´æ¨¡å‹">6.1. å®Œæ•´æ¨¡å‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-2-encoderdecoder-ç¼–ç å™¨-è§£ç å™¨ç»“æ„">6.2. EncoderDecoderï¼ˆç¼–ç å™¨-è§£ç å™¨ç»“æ„ï¼‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-3-encoder-ç¼–ç å™¨">6.3. Encoderï¼ˆç¼–ç å™¨ï¼‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-4-decoder-è§£ç å™¨">6.4. Decoderï¼ˆè§£ç å™¨ï¼‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-5-multiheadedattention-å¤šå¤´æ³¨æ„åŠ›">6.5. MultiHeadedAttentionï¼ˆå¤šå¤´æ³¨æ„åŠ›ï¼‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-6-positionwisefeedforward-åŸºäºä½ç½®çš„å‰é¦ˆç½‘ç»œ">6.6. PositionwiseFeedForwardï¼ˆåŸºäºä½ç½®çš„å‰é¦ˆç½‘ç»œï¼‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-7-embeddings-åµŒå…¥å±‚">6.7. Embeddingsï¼ˆåµŒå…¥å±‚ï¼‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-8-positionalencoding-ä½ç½®ç¼–ç ">6.8. PositionalEncodingï¼ˆä½ç½®ç¼–ç ï¼‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-9-generator-ç”Ÿæˆå™¨">6.9. Generatorï¼ˆç”Ÿæˆå™¨ï¼‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-10-clones-å…‹éš†">6.10. clonesï¼ˆå…‹éš†ï¼‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-11-layernorm-å±‚å½’ä¸€åŒ–">6.11. LayerNormï¼ˆå±‚å½’ä¸€åŒ–ï¼‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-12-sublayerconnection-å­å±‚è¿æ¥">6.12. SublayerConnectionï¼ˆå­å±‚è¿æ¥ï¼‰</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="vp-link toc-link level3 toc-link level3" href="#_6-13-æ¨¡å‹ä½¿ç”¨çš„ä¾‹å­">6.13. æ¨¡å‹ä½¿ç”¨çš„ä¾‹å­</a></li><!----><!--]--></ul></li><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h1 id="transformeræºç è§£è¯»" tabindex="-1"><a class="header-anchor" href="#transformeræºç è§£è¯»" aria-hidden="true">#</a> Transformeræºç è§£è¯»</h1><ul><li><ol><li>About</li></ol></li><li><ol start="2"><li>æ¨¡å‹æ€»ä½“æ¶æ„</li></ol></li><li><ol start="3"><li>è¶…å‚æ•°</li></ol></li><li><ol start="4"><li>å¼ é‡ç»´åº¦è½¬æ¢</li></ol></li><li><ol start="5"><li>å¯è®­ç»ƒå‚æ•°é‡</li></ol></li><li><ol start="6"><li>æºç </li></ol></li></ul><!-- more --><h2 id="_1-about" tabindex="-1"><a class="header-anchor" href="#_1-about" aria-hidden="true">#</a> 1. About</h2><p>è®ºæ–‡ï¼šAttention Is All You Need</p><p>å¹´ä»½ï¼š2017</p><p>å…¬å¸ï¼šGoogle</p><p>æºç ï¼ˆå“ˆä½›NLPå›¢é˜Ÿå®ç°çš„Pytorchç‰ˆï¼‰ï¼šhttps://github.com/harvardnlp/annotated-transformer/</p><p>é…å¥—æºç è§£æï¼š https://nlp.seas.harvard.edu/annotated-transformer/</p><h2 id="_2-æ¨¡å‹æ€»ä½“æ¶æ„" tabindex="-1"><a class="header-anchor" href="#_2-æ¨¡å‹æ€»ä½“æ¶æ„" aria-hidden="true">#</a> 2. æ¨¡å‹æ€»ä½“æ¶æ„</h2><figure><img src="/blog/assets/Transformer_Overall_Architecture-3tnx_yjq.png" alt="Transformeræ¨¡å‹æ€»ä½“æ¶æ„" tabindex="0" loading="lazy"><figcaption>Transformeræ¨¡å‹æ€»ä½“æ¶æ„</figcaption></figure><p>ç¼–ç å™¨ï¼ˆå·¦ä¾§éƒ¨åˆ†ï¼‰ï¼š&quot;Inputs&quot;è¿™æ˜¯ç¼–ç å™¨çš„è¾“å…¥ï¼Œæ¯”å¦‚è¯´ä½ ä¸­æ–‡ç¿»è‹±æ–‡çš„è¯ï¼Œé‚£ä¹ˆè¿™å°±æ˜¯ä½ ä¸­æ–‡çš„å¥å­ã€‚ç¼–ç å™¨å°†è¾“å…¥åºåˆ—ï¼ˆx<sub>1</sub>,...,x<sub>n</sub>ï¼‰æ˜ å°„ä¸ºä¸€ç³»åˆ—å‘é‡è¡¨ç¤º z =ï¼ˆz<sub>1</sub>,...,z<sub>n</sub>ï¼‰ã€‚å…¶ä¸­æ¯ä¸ªx<sub>t</sub>è¡¨ç¤ºè¾“å…¥åºåˆ—ä¸­çš„ç¬¬tä¸ªå…ƒç´ ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªå•è¯ï¼‰ï¼Œæ¯ä¸ªz<sub>t</sub>æ˜¯ç›¸å¯¹äºx<sub>t</sub>çš„å‘é‡è¡¨ç¤ºã€‚è¿™äº›å‘é‡è¡¨ç¤ºå¯ä»¥è¢«è§†ä¸ºè¾“å…¥åºåˆ—çš„æŠ½è±¡è¡¨ç¤ºï¼Œä½¿å¾—æœºå™¨å­¦ä¹ æ¨¡å‹èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£è¾“å…¥åºåˆ—ã€‚</p><p>è§£ç å™¨ï¼ˆå³ä¾§éƒ¨åˆ†ï¼‰ï¼š&quot;Outputs&quot;è¿™æ˜¯è§£ç å™¨çš„è¾“å…¥ï¼Œè§£ç å™¨åœ¨åšé¢„æµ‹çš„æ—¶å€™æ˜¯æ²¡æœ‰è¾“å…¥çš„ã€‚&quot;Shifted Right&quot;å°±æ˜¯ä¸€ä¸ªä¸€ä¸ªå¾€å³ç§»ã€‚è§£ç å™¨æ ¹æ®ç¼–ç å™¨çš„è¾“å‡ºè¿›è¡Œå·¥ä½œï¼Œå¯¹zä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œç”Ÿæˆç›®æ ‡åºåˆ—ï¼ˆy<sub>1</sub>,...,y<sub>m</sub>ï¼‰,ä¸€ä¸ªæ—¶é—´æ­¥ç”Ÿæˆä¸€ä¸ªå…ƒç´ ï¼Œå…¶ä¸­må¯èƒ½ä¸nä¸åŒã€‚åœ¨æ¯ä¸€æ­¥ä¸­ï¼Œæ¨¡å‹éƒ½æ˜¯è‡ªå›å½’çš„ï¼Œåœ¨ç”Ÿæˆä¸‹ä¸€ä¸ªç»“æœæ—¶ï¼Œä¼šå°†å…ˆå‰ç”Ÿæˆçš„ç»“æœåŠ å…¥è¾“å…¥åºåˆ—æ¥ä¸€èµ·é¢„æµ‹ã€‚ï¼ˆè‡ªå›å½’æ¨¡å‹çš„ç‰¹ç‚¹ï¼‰</p><p>è§£ç å™¨ä¸ç¼–ç å™¨çš„ä¸€ä¸ªé‡è¦åŒºåˆ«æ˜¯ï¼Œè§£ç å™¨æ˜¯è‡ªå›å½’çš„ï¼ˆauto-regressiveï¼‰ã€‚è¿™æ„å‘³ç€å®ƒé€æ­¥ç”Ÿæˆè¾“å‡ºåºåˆ—ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å¤„ç†æ•´ä¸ªåºåˆ—ã€‚åœ¨ç”Ÿæˆç¬¬ä¸€ä¸ªè¾“å‡ºy<sub>1</sub>ä¹‹åï¼Œè§£ç å™¨ä½¿ç”¨å…ˆå‰ç”Ÿæˆçš„è¾“å‡ºä½œä¸ºè¾“å…¥æ¥ç”Ÿæˆä¸‹ä¸€ä¸ªè¾“å‡ºï¼Œä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°ç”Ÿæˆå®Œæ•´çš„ç›®æ ‡åºåˆ—ã€‚</p><p>æ€»ç»“æ¥è¯´ï¼Œç¼–ç å™¨å°†è¾“å…¥åºåˆ—è½¬æ¢ä¸ºä¸€ç³»åˆ—å‘é‡è¡¨ç¤ºï¼Œè€Œè§£ç å™¨æ ¹æ®ç¼–ç å™¨çš„è¾“å‡ºé€æ­¥ç”Ÿæˆç›®æ ‡åºåˆ—ã€‚è§£ç å™¨çš„è‡ªå›å½’ç‰¹æ€§ä½¿å¾—å®ƒèƒ½å¤Ÿé€æ­¥ç”Ÿæˆè¾“å‡ºï¼Œå¹¶åˆ©ç”¨å…ˆå‰ç”Ÿæˆçš„è¾“å‡ºä½œä¸ºè¾“å…¥ã€‚è¿™ç§ç¼–ç å™¨-è§£ç å™¨æ¶æ„åœ¨åºåˆ—åˆ°åºåˆ—ä»»åŠ¡ä¸­è¢«å¹¿æ³›åº”ç”¨ï¼Œå¦‚æœºå™¨ç¿»è¯‘ã€æ‘˜è¦ç”Ÿæˆç­‰ã€‚</p><figure><img src="/blog/assets/Transformer_Source_Code_Architecture-wdUsfZDe.jpg" alt="æºç å¯¹ç…§æ¨¡å‹æ¶æ„" tabindex="0" loading="lazy"><figcaption>æºç å¯¹ç…§æ¨¡å‹æ¶æ„</figcaption></figure><h2 id="_3-è¶…å‚æ•°" tabindex="-1"><a class="header-anchor" href="#_3-è¶…å‚æ•°" aria-hidden="true">#</a> 3. è¶…å‚æ•°</h2><figure><img src="/blog/assets/Transformer_Hyperparameters-ePsO0-QM.png" alt="è¶…å‚æ•°" tabindex="0" loading="lazy"><figcaption>è¶…å‚æ•°</figcaption></figure><h2 id="_4-å¼ é‡ç»´åº¦è½¬æ¢" tabindex="-1"><a class="header-anchor" href="#_4-å¼ é‡ç»´åº¦è½¬æ¢" aria-hidden="true">#</a> 4. å¼ é‡ç»´åº¦è½¬æ¢</h2><figure><img src="/blog/assets/Encoder_Tensor_Dimension_Transformation--hFf2Slu.png" alt="ç¼–ç å™¨å¼ é‡ç»´åº¦è½¬æ¢" tabindex="0" loading="lazy"><figcaption>ç¼–ç å™¨å¼ é‡ç»´åº¦è½¬æ¢</figcaption></figure><figure><img src="/blog/assets/Decoder_Tensor_Dimension_Transformation-F_HW4iby.png" alt="è§£ç å™¨å¼ é‡ç»´åº¦è½¬æ¢" tabindex="0" loading="lazy"><figcaption>è§£ç å™¨å¼ é‡ç»´åº¦è½¬æ¢</figcaption></figure><h2 id="_5-å¯è®­ç»ƒå‚æ•°é‡" tabindex="-1"><a class="header-anchor" href="#_5-å¯è®­ç»ƒå‚æ•°é‡" aria-hidden="true">#</a> 5. å¯è®­ç»ƒå‚æ•°é‡</h2><figure><img src="/blog/assets/Trainable_Parameters-NgRC5WB4.png" alt="å¯è®­ç»ƒå‚æ•°é‡" tabindex="0" loading="lazy"><figcaption>å¯è®­ç»ƒå‚æ•°é‡</figcaption></figure><h3 id="_5-1-multiheadedattention" tabindex="-1"><a class="header-anchor" href="#_5-1-multiheadedattention" aria-hidden="true">#</a> 5.1. MultiHeadedAttention</h3><p>è¯¥å—çš„æ¨¡å‹å‚æ•°ï¼šMultiHeadedAttentionçš„4ä¸ªçº¿æ€§å˜æ¢çš„æƒé‡å’Œåç½®ã€‚<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mtext>ã€</mtext><mi>K</mi><mtext>ã€</mtext><mi>V</mi></mrow><annotation encoding="application/x-tex">Qã€Kã€V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mord cjk_fallback">ã€</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord cjk_fallback">ã€</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span>çš„æƒé‡çŸ©é˜µ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>Q</mi></msub><mtext>ã€</mtext><msub><mi>W</mi><mi>K</mi></msub><mtext>ã€</mtext><msub><mi>W</mi><mi>V</mi></msub></mrow><annotation encoding="application/x-tex">W_Qã€W_Kã€W_V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mord cjk_fallback">ã€</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord cjk_fallback">ã€</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>å’Œå¯¹åº”åç½®ï¼Œä»¥åŠè¾“å‡ºæƒé‡çŸ©é˜µ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>O</mi></msub></mrow><annotation encoding="application/x-tex">W_O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>å’Œå¯¹åº”åç½®</p><p>è¯¥å—çš„å‚æ•°é‡å¤§å°ï¼š4ä¸ªæƒé‡çŸ©é˜µçš„å½¢çŠ¶ä¸º<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>d</mi><mo>=</mo><mn>512</mn><mo separator="true">,</mo><mi>d</mi><mo>=</mo><mn>512</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[d=512,d=512]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord">512</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">512</span><span class="mclose">]</span></span></span></span>, 4ä¸ªåç½®çš„å½¢çŠ¶ä¸º<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>d</mi><mo>=</mo><mn>512</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[d=512]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">512</span><span class="mclose">]</span></span></span></span>, MultiHeadedAttentionå—æ€»çš„å‚æ•°é‡ä¸º<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mo>âˆ—</mo><mo stretchy="false">(</mo><msup><mi>d</mi><mn>2</mn></msup><mo>+</mo><mi>d</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">4*(d^2+d)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mclose">)</span></span></span></span></p><p>è¯¥å—çš„ä¸ªæ•°ï¼šç¼–ç å±‚æœ‰1ä¸ªå­å±‚æ˜¯MultiHeadedAttentionï¼Œè§£ç å±‚æœ‰2ä¸ªå­å±‚æ˜¯MultiHeadedAttentionï¼Œç¼–ç å™¨å’Œè§£ç å™¨åˆ†åˆ«æœ‰6ä¸ªç›¸åŒçš„ç¼–ç å±‚å’Œè§£ç å±‚ï¼Œæ‰€ä»¥æ€»å…±æœ‰18ä¸ªMultiHeadedAttentionå—</p><p>Transformerä¸­è¯¥å—æ€»çš„å‚æ•°é‡ï¼š<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>18</mn><mo>âˆ—</mo><mn>4</mn><mo>âˆ—</mo><mo stretchy="false">(</mo><msup><mi>d</mi><mn>2</mn></msup><mo>+</mo><mi>d</mi><mo stretchy="false">)</mo><mo>=</mo><mn>72</mn><mo>âˆ—</mo><mo stretchy="false">(</mo><msup><mi>d</mi><mn>2</mn></msup><mo>+</mo><mi>d</mi><mo stretchy="false">)</mo><mo>=</mo><mn>18</mn><mo>âˆ—</mo><mn>4</mn><mo>âˆ—</mo><mo stretchy="false">(</mo><mn>51</mn><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mn>512</mn><mo stretchy="false">)</mo><mo>=</mo><mn>18911232</mn></mrow><annotation encoding="application/x-tex">18*4*(d^2+d)=72*(d^2+d)=18*4*(512^2+512)=18911232</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">18</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">72</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">18</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">51</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">512</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">18911232</span></span></span></span></p><h3 id="_5-2-positionwisefeedforward" tabindex="-1"><a class="header-anchor" href="#_5-2-positionwisefeedforward" aria-hidden="true">#</a> 5.2. PositionwiseFeedForward</h3><p>è¯¥å—çš„æ¨¡å‹å‚æ•°ï¼šPositionwiseFeedForwardçš„2ä¸ªçº¿æ€§å˜æ¢çš„æƒé‡å’Œåç½®ã€‚ç¬¬ä¸€ä¸ªçº¿æ€§å±‚æ˜¯å…ˆå°†ç»´åº¦ä»<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>=</mo><mn>512</mn></mrow><annotation encoding="application/x-tex">d=512</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">512</span></span></span></span>æ˜ å°„åˆ°<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mi>d</mi><mo>=</mo><mn>2048</mn></mrow><annotation encoding="application/x-tex">4d=2048</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">4</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2048</span></span></span></span>,ç¬¬äºŒä¸ªçº¿æ€§å±‚å†å°†ç»´åº¦ä»<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mi>d</mi><mo>=</mo><mn>2048</mn></mrow><annotation encoding="application/x-tex">4d=2048</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">4</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2048</span></span></span></span>æ˜ å°„åˆ°<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>=</mo><mn>512</mn></mrow><annotation encoding="application/x-tex">d=512</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">512</span></span></span></span></p><p>è¯¥å—çš„å‚æ•°é‡å¤§å°ï¼šç¬¬ä¸€ä¸ªçº¿æ€§å±‚çš„æƒé‡çŸ©é˜µ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">W_1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>çš„å½¢çŠ¶ä¸º<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>d</mi><mo>=</mo><mn>512</mn><mo separator="true">,</mo><mn>4</mn><mi>d</mi><mo>=</mo><mn>2048</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[d=512,4d=2048]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord">512</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">4</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2048</span><span class="mclose">]</span></span></span></span>,åç½®çš„å½¢çŠ¶ä¸º<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>4</mn><mi>d</mi><mo>=</mo><mn>2048</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[4d=2048]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">4</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">2048</span><span class="mclose">]</span></span></span></span>, ç¬¬äºŒä¸ªçº¿æ€§å±‚çš„æƒé‡çŸ©é˜µ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">W_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>çš„å½¢çŠ¶ä¸º<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>4</mn><mi>d</mi><mo>=</mo><mn>2048</mn><mo separator="true">,</mo><mi>d</mi><mo>=</mo><mn>512</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[4d=2048,d=512]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">4</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord">2048</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">512</span><span class="mclose">]</span></span></span></span>,åç½®çš„å½¢çŠ¶ä¸º<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>d</mi><mo>=</mo><mn>512</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[d=512]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">512</span><span class="mclose">]</span></span></span></span>, PositionwiseFeedForwardå—æ€»çš„å‚æ•°é‡ä¸º<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>âˆ—</mo><mn>4</mn><mi>d</mi><mo>+</mo><mn>4</mn><mi>d</mi><mo>+</mo><mn>4</mn><mi>d</mi><mo>âˆ—</mo><mi>d</mi><mo>+</mo><mi>d</mi><mo>=</mo><mn>8</mn><msup><mi>d</mi><mn>2</mn></msup><mo>+</mo><mn>5</mn><mi>d</mi></mrow><annotation encoding="application/x-tex">d*4d+4d+4d*d+d=8d^2+5d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord">4</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord">4</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">4</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord">8</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">5</span><span class="mord mathnormal">d</span></span></span></span></p><p>è¯¥å—çš„ä¸ªæ•°ï¼šç¼–ç å±‚å’Œè§£ç å±‚å„æœ‰1ä¸ªå­å±‚æ˜¯PositionwiseFeedForwardï¼Œç¼–ç å™¨å’Œè§£ç å™¨åˆ†åˆ«æœ‰6ä¸ªç›¸åŒçš„ç¼–ç å±‚å’Œè§£ç å±‚ï¼Œæ‰€ä»¥æ€»å…±æœ‰12ä¸ªPositionwiseFeedForwardå—</p><p>Transformerä¸­è¯¥å—æ€»çš„å‚æ•°é‡ï¼š<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>12</mn><mo>âˆ—</mo><mo stretchy="false">(</mo><mn>8</mn><msup><mi>d</mi><mn>2</mn></msup><mo>+</mo><mn>5</mn><mi>d</mi><mo stretchy="false">)</mo><mo>=</mo><mn>96</mn><msup><mi>d</mi><mn>2</mn></msup><mo>+</mo><mn>60</mn><mi>d</mi><mo>=</mo><mn>96</mn><mo>âˆ—</mo><mn>51</mn><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mn>60</mn><mo>âˆ—</mo><mn>512</mn><mo>=</mo><mn>25196544</mn></mrow><annotation encoding="application/x-tex">12*(8d^2+5d)=96d^2+60d=96*512^2+60*512=25196544</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">12</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">8</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">5</span><span class="mord mathnormal">d</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord">96</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">60</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">96</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord">51</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">60</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">512</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">25196544</span></span></span></span></p><h3 id="_5-3-layernorm" tabindex="-1"><a class="header-anchor" href="#_5-3-layernorm" aria-hidden="true">#</a> 5.3. LayerNorm</h3><p>è¯¥å—çš„æ¨¡å‹å‚æ•°ï¼šLayerNormåŒ…å«2ä¸ªå¯è®­ç»ƒå‚æ•°ï¼šç¼©æ”¾å‚æ•°<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Î³</mi></mrow><annotation encoding="application/x-tex">\gamma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05556em;">Î³</span></span></span></span>å’Œå¹³ç§»å‚æ•°<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Î²</mi></mrow><annotation encoding="application/x-tex">\beta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.05278em;">Î²</span></span></span></span></p><p>è¯¥å—çš„å‚æ•°é‡å¤§å°ï¼šä¸¤ä¸ªå‚æ•°å½¢çŠ¶éƒ½ä¸º<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>d</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[d]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal">d</span><span class="mclose">]</span></span></span></span>, LayerNormå—æ€»çš„å‚æ•°é‡ä¸º<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mo>+</mo><mi>d</mi><mo>=</mo><mn>2</mn><mi>d</mi></mrow><annotation encoding="application/x-tex">d+d=2d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">2</span><span class="mord mathnormal">d</span></span></span></span></p><p>è¯¥å—çš„ä¸ªæ•°ï¼šç¼–ç å±‚å’Œè§£ç å±‚çš„æ¯ä¸ªå­å±‚è¿æ¥æœ‰ä¸€ä¸ªLayerNormï¼Œå…±æœ‰5ä¸ªå­å±‚è¿æ¥ï¼Œç¼–ç å™¨å’Œè§£ç å™¨åˆ†åˆ«æœ‰6ä¸ªç›¸åŒçš„ç¼–ç å±‚å’Œè§£ç å±‚ï¼Œå¹¶åœ¨6ä¸ªç¼–ç å±‚å’Œè§£ç å±‚åæœ‰ä¸€ä¸ªLayerNormï¼Œæ‰€ä»¥æ€»å…±æœ‰<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>6</mn><mo>âˆ—</mo><mn>2</mn><mo>+</mo><mn>2</mn><mo>=</mo><mn>32</mn></mrow><annotation encoding="application/x-tex">6*2+2=32</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">6</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">32</span></span></span></span>ä¸ªLayerNormå—</p><p>Transformerä¸­è¯¥å—æ€»çš„å‚æ•°é‡ï¼š<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>32</mn><mo>âˆ—</mo><mn>2</mn><mi>d</mi><mo>=</mo><mn>64</mn><mi>d</mi><mo>=</mo><mn>64</mn><mo>âˆ—</mo><mn>512</mn><mo>=</mo><mn>32768</mn></mrow><annotation encoding="application/x-tex">32*2d=64d=64*512=32768</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">32</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">2</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord">64</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">64</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">512</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">32768</span></span></span></span></p><h3 id="_5-4-embeddings" tabindex="-1"><a class="header-anchor" href="#_5-4-embeddings" aria-hidden="true">#</a> 5.4. Embeddings</h3><p>è¯¥å—çš„æ¨¡å‹å‚æ•°ï¼šè¯¥å—å‡ºç°åœ¨Transformerä¸­çš„3ä¸ªä½ç½®ï¼ˆInput Embeddingsã€Output Embeddingsã€Generatorï¼‰ï¼Œä½†æ˜¯å‚æ•°å…±äº«ï¼Œæ‰€ä»¥åªæœ‰ä¸€ä»½å‚æ•°</p><p>è¯¥å—çš„å‚æ•°é‡å¤§å°ï¼šå½¢çŠ¶ä¸º<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>v</mi><mi>o</mi><mi>c</mi><mi>a</mi><mi>b</mi><mo separator="true">,</mo><mi>d</mi><mo>=</mo><mn>512</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[vocab,d=512]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">oc</span><span class="mord mathnormal">ab</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">512</span><span class="mclose">]</span></span></span></span>, Embeddingså—æ€»çš„å‚æ•°é‡ä¸º<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mi>o</mi><mi>c</mi><mi>a</mi><mi>b</mi><mo>âˆ—</mo><mi>d</mi></mrow><annotation encoding="application/x-tex">vocab*d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">oc</span><span class="mord mathnormal">ab</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span></p><p>è¯¥å—çš„ä¸ªæ•°ï¼š1</p><p>Transformerä¸­è¯¥å—æ€»çš„å‚æ•°é‡ï¼š<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mi>o</mi><mi>c</mi><mi>a</mi><mi>b</mi><mo>âˆ—</mo><mi>d</mi><mo>=</mo><mi>v</mi><mi>o</mi><mi>c</mi><mi>a</mi><mi>b</mi><mo>âˆ—</mo><mn>512</mn></mrow><annotation encoding="application/x-tex">vocab*d=vocab*512</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">oc</span><span class="mord mathnormal">ab</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">oc</span><span class="mord mathnormal">ab</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">512</span></span></span></span></p><h3 id="_5-5-æ€»çš„å¯è®­ç»ƒå‚æ•°é‡" tabindex="-1"><a class="header-anchor" href="#_5-5-æ€»çš„å¯è®­ç»ƒå‚æ•°é‡" aria-hidden="true">#</a> 5.5. æ€»çš„å¯è®­ç»ƒå‚æ•°é‡</h3><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>72</mn><mo>âˆ—</mo><mo stretchy="false">(</mo><msup><mi>d</mi><mn>2</mn></msup><mo>+</mo><mi>d</mi><mo stretchy="false">)</mo><mo>+</mo><mn>96</mn><msup><mi>d</mi><mn>2</mn></msup><mo>+</mo><mn>60</mn><mi>d</mi><mo>+</mo><mn>64</mn><mi>d</mi><mo>+</mo><mi>v</mi><mi>o</mi><mi>c</mi><mi>a</mi><mi>b</mi><mo>âˆ—</mo><mi>d</mi><mo>=</mo><mn>168</mn><mo>âˆ—</mo><msup><mi>d</mi><mn>2</mn></msup><mo>+</mo><mn>196</mn><mo>âˆ—</mo><mi>d</mi><mo>+</mo><mi>v</mi><mi>o</mi><mi>c</mi><mi>a</mi><mi>b</mi><mo>âˆ—</mo><mi>d</mi><mo>=</mo><mn>168</mn><mo>âˆ—</mo><mn>51</mn><msup><mn>2</mn><mn>2</mn></msup><mo>+</mo><mn>196</mn><mo>âˆ—</mo><mn>512</mn><mo>+</mo><mi>v</mi><mi>o</mi><mi>c</mi><mi>a</mi><mi>b</mi><mo>âˆ—</mo><mn>512</mn><mo>=</mo><mn>44140544</mn><mo>+</mo><mi>v</mi><mi>o</mi><mi>c</mi><mi>a</mi><mi>b</mi><mo>âˆ—</mo><mn>512</mn></mrow><annotation encoding="application/x-tex">72*(d^2+d)+96d^2+60d+64d+vocab*d=168*d^2+196*d+vocab*d=168*512^2+196*512+vocab*512=44140544+vocab*512</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">72</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">d</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord">96</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord">60</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord">64</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">oc</span><span class="mord mathnormal">ab</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">168</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">196</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">oc</span><span class="mord mathnormal">ab</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">168</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"></span><span class="mord">51</span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">196</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">512</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">oc</span><span class="mord mathnormal">ab</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">512</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">44140544</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">oc</span><span class="mord mathnormal">ab</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">âˆ—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">512</span></span></span></span></p><h2 id="_6-æºç " tabindex="-1"><a class="header-anchor" href="#_6-æºç " aria-hidden="true">#</a> 6. æºç </h2><h3 id="_6-1-å®Œæ•´æ¨¡å‹" tabindex="-1"><a class="header-anchor" href="#_6-1-å®Œæ•´æ¨¡å‹" aria-hidden="true">#</a> 6.1. å®Œæ•´æ¨¡å‹</h3><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> math
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">import</span> log_softmax
<span class="token keyword">import</span> copy

<span class="token keyword">def</span> <span class="token function">make_model</span><span class="token punctuation">(</span>src_vocab<span class="token punctuation">,</span> tgt_vocab<span class="token punctuation">,</span> N<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> d_model<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span> d_ff<span class="token operator">=</span><span class="token number">2048</span><span class="token punctuation">,</span> h<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> dropout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    æ ¹æ®è¶…å‚æ•°æ„å»ºä¸€ä¸ªæ¨¡å‹ã€‚
    src_vocab:æºå¥å­çš„å•è¯ä¸ªæ•°
    tgt_vocab:ç›®æ ‡å¥å­çš„å•è¯ä¸ªæ•°
    N:ç¼–ç å±‚å’Œè§£ç å±‚çš„å±‚æ•°
    d_model:è¯åµŒå…¥çš„ç»´åº¦/è¾“å…¥å’Œè¾“å‡ºçš„ç»´åº¦
    d_ff:Feed-Forwardç½‘ç»œä¸­éšè—å±‚çš„ç»´åº¦/å†…å±‚çš„ç»´åº¦
    h:æ³¨æ„åŠ›çš„å¤´æ•°
    dropout:æ˜¯ä¸€ç§é˜²æ­¢æ·±åº¦å­¦ä¹ ç½‘ç»œè¿‡æ‹Ÿåˆçš„æŠ€æœ¯ï¼Œå®ƒæ˜¯éšæœºä¸¢å¼ƒç¥ç»å…ƒï¼Œä»è€Œå¢åŠ ç½‘ç»œçš„æ³›åŒ–èƒ½åŠ›
    &quot;&quot;&quot;</span>
    c <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy <span class="token comment"># æ·±æ‹·è´</span>
    attn <span class="token operator">=</span> MultiHeadedAttention<span class="token punctuation">(</span>h<span class="token punctuation">,</span> d_model<span class="token punctuation">)</span>  <span class="token comment"># åˆ›å»ºå¤šå¤´æ³¨æ„åŠ›æœºåˆ¶å®ä¾‹</span>
    ff <span class="token operator">=</span> PositionwiseFeedForward<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> d_ff<span class="token punctuation">,</span> dropout<span class="token punctuation">)</span>  <span class="token comment"># åˆ›å»ºä½ç½®å‰é¦ˆç½‘ç»œå®ä¾‹</span>
    position <span class="token operator">=</span> PositionalEncoding<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> dropout<span class="token punctuation">)</span>  <span class="token comment"># åˆ›å»ºä½ç½®ç¼–ç å®ä¾‹</span>
    model <span class="token operator">=</span> EncoderDecoder<span class="token punctuation">(</span>
        Encoder<span class="token punctuation">(</span>EncoderLayer<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> c<span class="token punctuation">(</span>attn<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span>ff<span class="token punctuation">)</span><span class="token punctuation">,</span> dropout<span class="token punctuation">)</span><span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># åˆ›å»ºç¼–ç å™¨å®ä¾‹</span>
        Decoder<span class="token punctuation">(</span>DecoderLayer<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> c<span class="token punctuation">(</span>attn<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span>attn<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span>ff<span class="token punctuation">)</span><span class="token punctuation">,</span> dropout<span class="token punctuation">)</span><span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># åˆ›å»ºè§£ç å™¨å®ä¾‹</span>
        nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>Embeddings<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> src_vocab<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># åˆ›å»ºæºè¯­è¨€åµŒå…¥å±‚å®ä¾‹</span>
        nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>Embeddings<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> tgt_vocab<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">(</span>position<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># åˆ›å»ºç›®æ ‡è¯­è¨€åµŒå…¥å±‚å®ä¾‹</span>
        Generator<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> tgt_vocab<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># åˆ›å»ºç”Ÿæˆå™¨å®ä¾‹</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># åˆå§‹åŒ–å‚æ•°</span>
    <span class="token keyword">for</span> p <span class="token keyword">in</span> model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> p<span class="token punctuation">.</span>dim<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
            nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>xavier_uniform_<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    <span class="token keyword">return</span> model
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-2-encoderdecoder-ç¼–ç å™¨-è§£ç å™¨ç»“æ„" tabindex="-1"><a class="header-anchor" href="#_6-2-encoderdecoder-ç¼–ç å™¨-è§£ç å™¨ç»“æ„" aria-hidden="true">#</a> 6.2. EncoderDecoderï¼ˆç¼–ç å™¨-è§£ç å™¨ç»“æ„ï¼‰</h3><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">EncoderDecoder</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    A standard Encoder-Decoder architecture. Base for this and many other models.
    ä¸€ä¸ªæ ‡å‡†çš„ç¼–ç å™¨-è§£ç å™¨æ¶æ„ã€‚æ˜¯æœ¬ä¾‹å’Œè®¸å¤šå…¶ä»–æ¨¡å‹çš„åŸºç¡€ã€‚
    &quot;&quot;&quot;</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> encoder<span class="token punctuation">,</span> decoder<span class="token punctuation">,</span> src_embed<span class="token punctuation">,</span> tgt_embed<span class="token punctuation">,</span> generator<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>EncoderDecoder<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>encoder <span class="token operator">=</span> encoder <span class="token comment"># ç¼–ç å™¨</span>
        self<span class="token punctuation">.</span>decoder <span class="token operator">=</span> decoder <span class="token comment"># è§£ç å™¨</span>
        self<span class="token punctuation">.</span>src_embed <span class="token operator">=</span> src_embed <span class="token comment"># æºåµŒå…¥</span>
        self<span class="token punctuation">.</span>tgt_embed <span class="token operator">=</span> tgt_embed <span class="token comment"># ç›®æ ‡åµŒå…¥</span>
        self<span class="token punctuation">.</span>generator <span class="token operator">=</span> generator <span class="token comment"># ç”Ÿæˆå™¨</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> src<span class="token punctuation">,</span> tgt<span class="token punctuation">,</span> src_mask<span class="token punctuation">,</span> tgt_mask<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token string">&quot;Take in and process masked src and target sequences.&quot;</span>
        <span class="token string">&quot;æ¥æ”¶å¹¶å¤„ç† mask çš„ æºï¼ˆsrcï¼‰ å’Œ ç›®æ ‡ï¼ˆtargetï¼‰ åºåˆ—ã€‚&quot;</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>self<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>src<span class="token punctuation">,</span> src_mask<span class="token punctuation">)</span><span class="token punctuation">,</span> src_mask<span class="token punctuation">,</span> tgt<span class="token punctuation">,</span> tgt_mask<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">encode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> src<span class="token punctuation">,</span> src_mask<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>encoder<span class="token punctuation">(</span>self<span class="token punctuation">.</span>src_embed<span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">,</span> src_mask<span class="token punctuation">)</span> <span class="token comment"># å¯¹æºåºåˆ—è¿›è¡Œç¼–ç </span>

    <span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> memory<span class="token punctuation">,</span> src_mask<span class="token punctuation">,</span> tgt<span class="token punctuation">,</span> tgt_mask<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>decoder<span class="token punctuation">(</span>self<span class="token punctuation">.</span>tgt_embed<span class="token punctuation">(</span>tgt<span class="token punctuation">)</span><span class="token punctuation">,</span> memory<span class="token punctuation">,</span> src_mask<span class="token punctuation">,</span> tgt_mask<span class="token punctuation">)</span> <span class="token comment"># å¯¹ç›®æ ‡åºåˆ—è¿›è¡Œè§£ç </span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-3-encoder-ç¼–ç å™¨" tabindex="-1"><a class="header-anchor" href="#_6-3-encoder-ç¼–ç å™¨" aria-hidden="true">#</a> 6.3. Encoderï¼ˆç¼–ç å™¨ï¼‰</h3><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Encoder</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Core encoder is a stack of N layers
    ç¼–ç å™¨ç”±N=6ä¸ªå®Œå…¨ç›¸åŒçš„å±‚ç»„æˆã€‚
    åŒ…å«N=6ä¸ªå±‚çš„å †å 
    &quot;&quot;&quot;</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> layer<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Encoder<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layers <span class="token operator">=</span> clones<span class="token punctuation">(</span>layer<span class="token punctuation">,</span> N<span class="token punctuation">)</span> <span class="token comment"># åˆ›å»º N ä¸ª layer çš„å‰¯æœ¬ï¼Œå¹¶å­˜å‚¨åœ¨ self.layers ä¸­</span>
        self<span class="token punctuation">.</span>norm <span class="token operator">=</span> LayerNorm<span class="token punctuation">(</span>layer<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token comment"># åˆ›å»ºä¸€ä¸ª LayerNorm ï¼Œå¹¶å­˜å‚¨åœ¨ self.norm ä¸­</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token string">&quot;Pass the input (and mask) through each layer in turn.é€å±‚ä¼ é€’è¾“å…¥å’Œæ©ç &quot;</span>
        <span class="token keyword">for</span> layer <span class="token keyword">in</span> self<span class="token punctuation">.</span>layers<span class="token punctuation">:</span>
            x <span class="token operator">=</span> layer<span class="token punctuation">(</span>x<span class="token punctuation">,</span> mask<span class="token punctuation">)</span> <span class="token comment"># é€å±‚å¯¹è¾“å…¥ x è¿›è¡Œå¤„ç†</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment"># å¯¹å¤„ç†åçš„ç»“æœ x è¿›è¡Œ Layer Normalizationï¼ˆå±‚å½’ä¸€åŒ–ï¼‰</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">EncoderLayer</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">&quot;Encoder is made up of self-attn and feed forward (defined below) ç¼–ç å™¨ç”±è‡ªæ³¨æ„åŠ›å’Œå‰é¦ˆç¥ç»ç½‘ç»œç»„æˆï¼ˆå¦‚ä¸‹ï¼‰ã€‚&quot;</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> size<span class="token punctuation">,</span> self_attn<span class="token punctuation">,</span> feed_forward<span class="token punctuation">,</span> dropout<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>EncoderLayer<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>self_attn <span class="token operator">=</span> self_attn <span class="token comment"># è‡ªæ³¨æ„åŠ›æœºåˆ¶</span>
        self<span class="token punctuation">.</span>feed_forward <span class="token operator">=</span> feed_forward <span class="token comment"># å‰é¦ˆç¥ç»ç½‘ç»œ</span>
        self<span class="token punctuation">.</span>sublayer <span class="token operator">=</span> clones<span class="token punctuation">(</span>SublayerConnection<span class="token punctuation">(</span>size<span class="token punctuation">,</span> dropout<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># å…‹éš†ä¸¤ä¸ªå­å±‚è¿æ¥</span>
        self<span class="token punctuation">.</span>size <span class="token operator">=</span> size

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token string">&quot;Follow Figure 1 (left) for connections. å‚è€ƒå›¾1ï¼ˆå·¦ä¾§ï¼‰è¿›è¡Œè¿æ¥ã€‚&quot;</span>
        <span class="token comment"># ç¬¬ä¸€ä¸ªå­å±‚è¿æ¥ï¼šè‡ªæ³¨æ„åŠ›æœºåˆ¶</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>sublayer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> self<span class="token punctuation">.</span>self_attn<span class="token punctuation">(</span>x<span class="token punctuation">,</span> x<span class="token punctuation">,</span> x<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># ç¬¬äºŒä¸ªå­å±‚è¿æ¥ï¼šå‰é¦ˆç¥ç»ç½‘ç»œ</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>sublayer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>feed_forward<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-4-decoder-è§£ç å™¨" tabindex="-1"><a class="header-anchor" href="#_6-4-decoder-è§£ç å™¨" aria-hidden="true">#</a> 6.4. Decoderï¼ˆè§£ç å™¨ï¼‰</h3><p>è§£ç å™¨ä¹Ÿæ˜¯ç”± <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mn>6</mn></mrow><annotation encoding="application/x-tex">N=6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">6</span></span></span></span> ä¸ªå®Œå…¨ç›¸åŒçš„å±‚ç»„æˆã€‚</p><p>é™¤äº†æ¯ä¸ªdecoderå±‚ä¸­çš„ä¸¤ä¸ªå­å±‚ä¹‹å¤–ï¼Œdecoderè¿˜æœ‰ç¬¬ä¸‰ä¸ªå­å±‚ï¼Œè¯¥å±‚å¯¹encoderçš„è¾“å‡ºæ‰§è¡Œmulti-head attentionã€‚ï¼ˆå³encoder-decoder-attentionå±‚ï¼Œqå‘é‡æ¥è‡ªä¸Šä¸€å±‚çš„è¾“å…¥ï¼Œkå’Œvå‘é‡æ˜¯encoderæœ€åå±‚çš„è¾“å‡ºå‘é‡memoryï¼‰ä¸encoderç±»ä¼¼ï¼Œæˆ‘ä»¬åœ¨æ¯ä¸ªå­å±‚å†é‡‡ç”¨æ®‹å·®è¿æ¥ï¼Œç„¶åè¿›è¡Œå±‚æ ‡å‡†åŒ–ã€‚</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Decoder</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Generic N layer decoder with masking.
    é€šç”¨çš„ å¸¦æœ‰æ©ç ï¼ˆmaskingï¼‰çš„ Nå±‚è§£ç å™¨
    åŒ…å« N ä¸ªå±‚çš„å †å 
    &quot;&quot;&quot;</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> layer<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Decoder<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>layers <span class="token operator">=</span> clones<span class="token punctuation">(</span>layer<span class="token punctuation">,</span> N<span class="token punctuation">)</span> <span class="token comment"># å…‹éš†Nä¸ªè§£ç å™¨å±‚</span>
        self<span class="token punctuation">.</span>norm <span class="token operator">=</span> LayerNorm<span class="token punctuation">(</span>layer<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token comment"># å½’ä¸€åŒ–å±‚</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> memory<span class="token punctuation">,</span> src_mask<span class="token punctuation">,</span> tgt_mask<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> layer <span class="token keyword">in</span> self<span class="token punctuation">.</span>layers<span class="token punctuation">:</span>
            <span class="token comment"># åº”ç”¨æ¯ä¸ªè§£ç å™¨å±‚ï¼Œä¼ é€’è¾“å…¥xã€è®°å¿†memoryã€æºæ©ç src_maskå’Œç›®æ ‡æ©ç tgt_mask</span>
            x <span class="token operator">=</span> layer<span class="token punctuation">(</span>x<span class="token punctuation">,</span> memory<span class="token punctuation">,</span> src_mask<span class="token punctuation">,</span> tgt_mask<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token comment"># å¯¹è¾“å‡ºè¿›è¡Œå½’ä¸€åŒ–å¤„ç†</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">DecoderLayer</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">&quot;Decoder is made of self-attn, src-attn, and feed forward (defined below) è§£ç å™¨ç”±è‡ªæ³¨æ„åŠ›æœºåˆ¶ï¼ˆself-attnï¼‰ã€æºæ³¨æ„åŠ›æœºåˆ¶ï¼ˆsrc-attnï¼‰å’Œå‰é¦ˆç¥ç»ç½‘ç»œï¼ˆfeed forwardï¼‰ç»„æˆã€‚&quot;</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> size<span class="token punctuation">,</span> self_attn<span class="token punctuation">,</span> src_attn<span class="token punctuation">,</span> feed_forward<span class="token punctuation">,</span> dropout<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>DecoderLayer<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>size <span class="token operator">=</span> size <span class="token comment"># è§£ç å™¨å±‚çš„å¤§å°</span>
        self<span class="token punctuation">.</span>self_attn <span class="token operator">=</span> self_attn <span class="token comment"># è‡ªæ³¨æ„åŠ›æœºåˆ¶</span>
        self<span class="token punctuation">.</span>src_attn <span class="token operator">=</span> src_attn <span class="token comment"># æºæ³¨æ„åŠ›æœºåˆ¶</span>
        self<span class="token punctuation">.</span>feed_forward <span class="token operator">=</span> feed_forward <span class="token comment"># å‰é¦ˆç¥ç»ç½‘ç»œ</span>
        self<span class="token punctuation">.</span>sublayer <span class="token operator">=</span> clones<span class="token punctuation">(</span>SublayerConnection<span class="token punctuation">(</span>size<span class="token punctuation">,</span> dropout<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token comment"># å…‹éš†ä¸‰ä¸ªå­å±‚è¿æ¥</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> memory<span class="token punctuation">,</span> src_mask<span class="token punctuation">,</span> tgt_mask<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token string">&quot;Follow Figure 1 (right) for connections. å‚è€ƒå›¾1ï¼ˆå³ä¾§ï¼‰è¿›è¡Œè¿æ¥ã€‚&quot;</span>
        m <span class="token operator">=</span> memory <span class="token comment"># è®°å¿†</span>
        <span class="token comment"># ç¬¬ä¸€ä¸ªå­å±‚è¿æ¥ï¼šè‡ªæ³¨æ„åŠ›æœºåˆ¶</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>sublayer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> self<span class="token punctuation">.</span>self_attn<span class="token punctuation">(</span>x<span class="token punctuation">,</span> x<span class="token punctuation">,</span> x<span class="token punctuation">,</span> tgt_mask<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># ç¬¬äºŒä¸ªå­å±‚è¿æ¥ï¼šæºæ³¨æ„åŠ›æœºåˆ¶</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>sublayer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> self<span class="token punctuation">.</span>src_attn<span class="token punctuation">(</span>x<span class="token punctuation">,</span> m<span class="token punctuation">,</span> m<span class="token punctuation">,</span> src_mask<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># ç¬¬ä¸‰ä¸ªå­å±‚è¿æ¥ï¼šå‰é¦ˆç¥ç»ç½‘ç»œ</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>sublayer<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>feed_forward<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-5-multiheadedattention-å¤šå¤´æ³¨æ„åŠ›" tabindex="-1"><a class="header-anchor" href="#_6-5-multiheadedattention-å¤šå¤´æ³¨æ„åŠ›" aria-hidden="true">#</a> 6.5. MultiHeadedAttentionï¼ˆå¤šå¤´æ³¨æ„åŠ›ï¼‰</h3><p>ä¸ºä»€ä¹ˆä½¿ç”¨å¤šå¤´çš„ä¸¤ç‚¹æ¦‚æ‹¬ï¼šâ‘ ä¸ºäº†è§£å†³æ¨¡å‹åœ¨å¯¹å½“å‰ä½ç½®çš„ä¿¡æ¯è¿›è¡Œç¼–ç æ—¶ï¼Œä¼šè¿‡åº¦çš„å°†æ³¨æ„åŠ›é›†ä¸­äºè‡ªèº«ä½ç½®çš„é—®é¢˜ï¼›â‘¡ä¸€å®šç¨‹åº¦ä¸Šhè¶Šå¤§æ•´ä¸ªæ¨¡å‹çš„è¡¨è¾¾èƒ½åŠ›è¶Šå¼ºï¼Œè¶Šèƒ½æé«˜æ¨¡å‹å¯¹äºæ³¨æ„åŠ›æƒé‡çš„åˆç†åˆ†é…ã€‚</p><p>ä¸ºä»€ä¹ˆè¦ç¼©æ”¾ï¼šå¯¹äºè¾ƒå¤§çš„<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">d_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>æ¥è¯´åœ¨å®Œæˆ<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">QK^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span>åå°†ä¼šå¾—åˆ°å¾ˆå¤§çš„å€¼ï¼Œè€Œè¿™å°†å¯¼è‡´åœ¨ç»è¿‡sofrmaxæ“ä½œåäº§ç”Ÿéå¸¸å°çš„æ¢¯åº¦ï¼Œä¸åˆ©äºç½‘ç»œçš„è®­ç»ƒ</p><p>åœ¨å®è·µä¸­ï¼Œæˆ‘ä»¬åŒæ—¶è®¡ç®—ä¸€ç»„queryçš„attentionå‡½æ•°ï¼Œå¹¶å°†å®ƒä»¬ç»„åˆæˆä¸€ä¸ªçŸ©é˜µ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">Q</span></span></span></span>. keyå’Œvalueä¹Ÿä¸€èµ·ç»„æˆçŸ©é˜µ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> å’Œ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span>. ã€‚ æˆ‘ä»¬è®¡ç®—çš„è¾“å‡ºçŸ©é˜µä¸ºï¼š</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">s</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">m</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">x</mi></mrow><mo stretchy="false">(</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo stretchy="false">)</mo><mi>V</mi></mrow><annotation encoding="application/x-tex"> \mathrm{Attention}(Q, K, V) = \mathrm{softmax}(\frac{QK^T}{\sqrt{d_k}})V </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathrm">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.4483em;vertical-align:-0.93em;"></span><span class="mord"><span class="mord mathrm">softmax</span></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.2528em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"></span><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewBox="0 0 400000 1080" preserveAspectRatio="xMinYMin slice"><path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path></svg></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p><p>å…¶ä¸­Qã€Kå’ŒVåˆ†åˆ«ä¸º3ä¸ªçŸ©é˜µï¼Œä¸”å…¶ï¼ˆç¬¬2ä¸ªï¼‰ç»´åº¦åˆ†åˆ«ä¸º<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>q</mi></msub><mo separator="true">,</mo><msub><mi>d</mi><mi>k</mi></msub><mo separator="true">,</mo><msub><mi>d</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">d_q,d_k,d_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>,ä»åé¢çš„è®¡ç®—è¿‡ç¨‹å…¶å®å¯ä»¥å‘ç°<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>q</mi></msub><mo>=</mo><msub><mi>d</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">d_q = d_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ã€‚</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">attention</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> mask<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> dropout<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;ç¼©æ”¾çš„ç‚¹ç§¯æ³¨æ„åŠ›
     &#39;Scaled Dot Product Attention&#39;
    queryã€keyã€valueå’Œè¾“å‡ºéƒ½æ˜¯å‘é‡ã€‚è¾“å‡ºä¸ºvalueçš„åŠ æƒå’Œï¼Œå…¶ä¸­æ¯ä¸ªvalueçš„æƒé‡é€šè¿‡queryä¸ç›¸åº”keyçš„å…¼å®¹å‡½æ•°æ¥è®¡ç®—
    &quot;&quot;&quot;</span>

    d_k <span class="token operator">=</span> query<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># è·å–æŸ¥è¯¢å‘é‡çš„æœ€åä¸€ä¸ªç»´åº¦å¤§å°ï¼Œå³æ³¨æ„åŠ›çš„ç»´åº¦</span>

    scores <span class="token operator">=</span> torch<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>query<span class="token punctuation">,</span> key<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>d_k<span class="token punctuation">)</span>  <span class="token comment"># è®¡ç®—æ³¨æ„åŠ›å¾—åˆ†</span>

    <span class="token keyword">if</span> mask <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        scores <span class="token operator">=</span> scores<span class="token punctuation">.</span>masked_fill<span class="token punctuation">(</span>mask <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1e9</span><span class="token punctuation">)</span>  <span class="token comment"># å¯¹æ©ç ä¸º0çš„ä½ç½®è¿›è¡Œå¡«å……ï¼Œä½¿å¾—å¯¹åº”ä½ç½®çš„æ³¨æ„åŠ›å¾—åˆ†å˜ä¸ºä¸€ä¸ªå¾ˆå°çš„è´Ÿæ•°</span>

    p_attn <span class="token operator">=</span> scores<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># å¯¹æ³¨æ„åŠ›å¾—åˆ†è¿›è¡Œsoftmaxå½’ä¸€åŒ–ï¼Œå¾—åˆ°æ³¨æ„åŠ›æƒé‡</span>

    <span class="token keyword">if</span> dropout <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        p_attn <span class="token operator">=</span> dropout<span class="token punctuation">(</span>p_attn<span class="token punctuation">)</span>  <span class="token comment"># å¯¹æ³¨æ„åŠ›æƒé‡è¿›è¡Œdropoutæ“ä½œ</span>

    <span class="token keyword">return</span> torch<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>p_attn<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span> p_attn  <span class="token comment"># è¿”å›åŠ æƒåçš„valueå’Œæ³¨æ„åŠ›æƒé‡</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mi mathvariant="normal">M</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">H</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">d</mi></mrow><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mi mathvariant="normal">C</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">c</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi></mrow><mo stretchy="false">(</mo><mrow><mi mathvariant="normal">h</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">a</mi><msub><mi mathvariant="normal">d</mi><mn>1</mn></msub></mrow><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mrow><mi mathvariant="normal">h</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">a</mi><msub><mi mathvariant="normal">d</mi><mi mathvariant="normal">h</mi></msub></mrow><mo stretchy="false">)</mo><msup><mi>W</mi><mi>O</mi></msup><mspace linebreak="newline"></mspace><mtext>whereÂ </mtext><mrow><mi mathvariant="normal">h</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">a</mi><msub><mi mathvariant="normal">d</mi><mi mathvariant="normal">i</mi></msub></mrow><mo>=</mo><mrow><mi mathvariant="normal">A</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi></mrow><mo stretchy="false">(</mo><mi>Q</mi><msubsup><mi>W</mi><mi>i</mi><mi>Q</mi></msubsup><mo separator="true">,</mo><mi>K</mi><msubsup><mi>W</mi><mi>i</mi><mi>K</mi></msubsup><mo separator="true">,</mo><mi>V</mi><msubsup><mi>W</mi><mi>i</mi><mi>V</mi></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex"> \mathrm{MultiHead}(Q, K, V) = \mathrm{Concat}(\mathrm{head_1}, ..., \mathrm{head_h})W^O \\ \text{where}~\mathrm{head_i} = \mathrm{Attention}(QW^Q_i, KW^K_i, VW^V_i) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathrm">MultiHead</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1413em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathrm">Concat</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathrm">hea</span><span class="mord"><span class="mord mathrm">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathrm">hea</span><span class="mord"><span class="mord mathrm">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">h</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord text"><span class="mord">where</span></span><span class="mspace nobreak">Â </span><span class="mord"><span class="mord mathrm">hea</span><span class="mord"><span class="mord mathrm">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3175em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathrm mtight">i</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.2769em;"></span><span class="mord"><span class="mord mathrm">Attention</span></span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9592em;"><span style="top:-2.4231em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><p>å…¶ä¸­æ˜ å°„ç”±æƒé‡çŸ©é˜µå®Œæˆï¼š <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>i</mi><mi>Q</mi></msubsup><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mtext>model</mtext></msub><mo>Ã—</mo><msub><mi>d</mi><mi>k</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">W^Q_i \in \mathbb{R}^{d_{\text{model}} \times d_k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2361em;vertical-align:-0.2769em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9592em;"><span style="top:-2.4231em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>i</mi><mi>K</mi></msubsup><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mtext>model</mtext></msub><mo>Ã—</mo><msub><mi>d</mi><mi>k</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">W^K_i \in \mathbb{R}^{d_{\text{model}} \times d_k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1em;vertical-align:-0.2587em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">K</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>i</mi><mi>V</mi></msubsup><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><msub><mi>d</mi><mtext>model</mtext></msub><mo>Ã—</mo><msub><mi>d</mi><mi>v</mi></msub></mrow></msup></mrow><annotation encoding="application/x-tex">W^V_i \in \mathbb{R}^{d_{\text{model}} \times d_v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1em;vertical-align:-0.2587em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4413em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>W</mi><mi>O</mi></msup><mo>âˆˆ</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>h</mi><msub><mi>d</mi><mi>v</mi></msub><mo>Ã—</mo><msub><mi>d</mi><mtext>model</mtext></msub></mrow></msup></mrow><annotation encoding="application/x-tex">W^O \in \mathbb{R}^{hd_v \times d_{\text{model}}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8804em;vertical-align:-0.0391em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">âˆˆ</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8491em;"></span><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">h</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1645em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">Ã—</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>.</p><p>åœ¨è¿™é¡¹å·¥ä½œä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo>=</mo><mn>8</mn></mrow><annotation encoding="application/x-tex">h=8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">8</span></span></span></span> ä¸ªå¹³è¡Œattentionå±‚æˆ–è€…å«headã€‚å¯¹äºè¿™äº›headä¸­çš„æ¯ä¸€ä¸ªï¼Œæˆ‘ä»¬ä½¿ç”¨ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub><mo>=</mo><msub><mi>d</mi><mi>v</mi></msub><mo>=</mo><msub><mi>d</mi><mtext>model</mtext></msub><mi mathvariant="normal">/</mi><mi>h</mi><mo>=</mo><mn>64</mn></mrow><annotation encoding="application/x-tex">d_k=d_v=d_{\text{model}}/h=64</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">64</span></span></span></span>ï¼Œå°†æ¯ä¸ªheadçš„ç»´åº¦å‡å°ï¼Œæ­¤æ—¶æ€»è®¡ç®—æˆæœ¬ä¸å…·æœ‰å…¨éƒ¨ç»´åº¦çš„å•ä¸ªhead attentionç›¸ä¼¼ã€‚</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">MultiHeadedAttention</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> h<span class="token punctuation">,</span> d_model<span class="token punctuation">,</span> dropout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MultiHeadedAttention<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> d_model <span class="token operator">%</span> h <span class="token operator">==</span> <span class="token number">0</span>
        <span class="token comment"># æˆ‘ä»¬å‡è®¾ d_v æ€»æ˜¯ç­‰äº d_k</span>
        self<span class="token punctuation">.</span>d_k <span class="token operator">=</span> d_model <span class="token operator">//</span> h  <span class="token comment"># æ¯ä¸ªå¤´éƒ¨çš„æ³¨æ„åŠ›ç»´åº¦</span>
        self<span class="token punctuation">.</span>h <span class="token operator">=</span> h  <span class="token comment"># å¤´éƒ¨çš„æ•°é‡</span>
        <span class="token comment"># å®šä¹‰å››ä¸ªLinear networks, å¤§å°æ˜¯(512, 512),é‡Œé¢æœ‰ä¸¤ç±»å¯è®­ç»ƒå‚æ•°ï¼ŒWeightsï¼Œå…¶å¤§å°ä¸º512*512ï¼Œä»¥åŠbiasesï¼Œå…¶å¤§å°ä¸º512=d_model</span>
        self<span class="token punctuation">.</span>linears <span class="token operator">=</span> clones<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> d_model<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>  <span class="token comment"># çº¿æ€§å˜æ¢å±‚çš„é›†åˆ</span>
        self<span class="token punctuation">.</span>attn <span class="token operator">=</span> <span class="token boolean">None</span> <span class="token comment"># ç”¨äºå­˜å‚¨æ³¨æ„åŠ›æƒé‡</span>
        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>p<span class="token operator">=</span>dropout<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> mask<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> mask <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token comment"># (batch.size,1,seq.len) -&gt; (batch.size,1,1,seq.len)</span>
            mask <span class="token operator">=</span> mask<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        nbatches <span class="token operator">=</span> query<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># æ‰¹æ¬¡å¤§å°</span>

        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        1) åœ¨æ‰¹æ¬¡ä¸­å¯¹æ‰€æœ‰çº¿æ€§æŠ•å½±è¿›è¡Œå¤„ç†
        è¿™é‡Œæ˜¯å‰ä¸‰ä¸ªLinear Networksçš„å…·ä½“åº”ç”¨ï¼Œ
        ä¾‹å¦‚query=(batch.size, seq.len, 512) -&gt; Linear network -&gt; (batch.size, seq.len, 512)
        -&gt; view -&gt; (batch.size, seq.len, 8, 64) -&gt; transpose(1,2) -&gt; (batch.size, 8, seq.len, 64)ï¼Œ
        å…¶ä»–çš„keyå’Œvalueä¹Ÿæ˜¯ç±»ä¼¼åœ°ï¼Œä»(batch.size, seq.len, 512) -&gt; (batch.size, 8, seq.len, 64)
        &quot;&quot;&quot;</span>
        query<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token punctuation">[</span>lin<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>nbatches<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>h<span class="token punctuation">,</span> self<span class="token punctuation">.</span>d_k<span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">for</span> lin<span class="token punctuation">,</span> x <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>linears<span class="token punctuation">,</span> <span class="token punctuation">(</span>query<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        <span class="token comment"># 2) åœ¨æ‰¹æ¬¡ä¸­å¯¹æ‰€æœ‰æŠ•å½±å‘é‡åº”ç”¨æ³¨æ„åŠ›æœºåˆ¶</span>
        x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>attn <span class="token operator">=</span> attention<span class="token punctuation">(</span>query<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> mask<span class="token operator">=</span>mask<span class="token punctuation">,</span> dropout<span class="token operator">=</span>self<span class="token punctuation">.</span>dropout<span class="token punctuation">)</span>

        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        3) ä½¿ç”¨è§†å›¾è¿›è¡Œ&quot;æ‹¼æ¥&quot;ï¼Œ
        x ~ (batch.size, 8, seq.len, 64) -&gt; transpose(1,2) -&gt;
        (batch.size, seq.len, 8, 64) -&gt; contiguous() and view -&gt;
        (batch.size, seq.len, 8*64) = (batch.size, seq.len, 512)
        &quot;&quot;&quot;</span>
        x <span class="token operator">=</span> <span class="token punctuation">(</span>
            x<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>view<span class="token punctuation">(</span>nbatches<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>h <span class="token operator">*</span> self<span class="token punctuation">.</span>d_k<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">del</span> query
        <span class="token keyword">del</span> key
        <span class="token keyword">del</span> value

        <span class="token comment"># 4) ç„¶ååº”ç”¨æœ€åä¸€ä¸ªçº¿æ€§å±‚</span>
        <span class="token comment"># æ‰§è¡Œç¬¬å››ä¸ªLinear networkï¼ŒæŠŠ(batch.size, seq.len, 512)ç»è¿‡ä¸€æ¬¡linear networkï¼Œå¾—åˆ°(batch.size, seq.len, 512)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>linears<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-6-positionwisefeedforward-åŸºäºä½ç½®çš„å‰é¦ˆç½‘ç»œ" tabindex="-1"><a class="header-anchor" href="#_6-6-positionwisefeedforward-åŸºäºä½ç½®çš„å‰é¦ˆç½‘ç»œ" aria-hidden="true">#</a> 6.6. PositionwiseFeedForwardï¼ˆåŸºäºä½ç½®çš„å‰é¦ˆç½‘ç»œï¼‰</h3><p>ç½‘ç»œåŒ…æ‹¬ä¸¤ä¸ªçº¿æ€§å˜æ¢ï¼Œå¹¶åœ¨ä¸¤ä¸ªçº¿æ€§å˜æ¢ä¸­é—´æœ‰ä¸€ä¸ªReLUæ¿€æ´»å‡½æ•°ã€‚</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mi mathvariant="normal">F</mi><mi mathvariant="normal">F</mi><mi mathvariant="normal">N</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><mi>max</mi><mo>â¡</mo><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mi>x</mi><msub><mi>W</mi><mn>1</mn></msub><mo>+</mo><msub><mi>b</mi><mn>1</mn></msub><mo stretchy="false">)</mo><msub><mi>W</mi><mn>2</mn></msub><mo>+</mo><msub><mi>b</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex"> \mathrm{FFN}(x)=\max(0, xW_1 + b_1) W_2 + b_2 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathrm">FFN</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">x</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p><p>å°½ç®¡ä¸¤å±‚éƒ½æ˜¯çº¿æ€§å˜æ¢ï¼Œä½†å®ƒä»¬åœ¨å±‚ä¸å±‚ä¹‹é—´ä½¿ç”¨ä¸åŒçš„å‚æ•°ã€‚è¾“å…¥å’Œè¾“å‡ºçš„ç»´åº¦éƒ½æ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mtext>model</mtext></msub><mo>=</mo><mn>512</mn></mrow><annotation encoding="application/x-tex">d_{\text{model}}=512</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">512</span></span></span></span> å†…å±‚ç»´åº¦æ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>f</mi><mi>f</mi></mrow></msub><mo>=</mo><mn>2048</mn></mrow><annotation encoding="application/x-tex">d_{ff}=2048</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">ff</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2048</span></span></span></span>ã€‚ï¼ˆä¹Ÿå°±æ˜¯ç¬¬ä¸€å±‚è¾“å…¥512ç»´,è¾“å‡º2048ç»´ï¼›ç¬¬äºŒå±‚è¾“å…¥2048ç»´ï¼Œè¾“å‡º512ç»´ï¼‰</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">PositionwiseFeedForward</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">&quot;å®ç° FFNï¼ˆFeed-Forward Networkï¼‰&quot;</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> d_model<span class="token punctuation">,</span> d_ff<span class="token punctuation">,</span> dropout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># d_model = 512</span>
        <span class="token comment"># d_ff = 2048 = 512*4</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>PositionwiseFeedForward<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># æ„å»ºç¬¬ä¸€ä¸ªå…¨è¿æ¥å±‚ï¼Œ(512, 2048)ï¼Œå…¶ä¸­æœ‰ä¸¤ç§å¯è®­ç»ƒå‚æ•°ï¼šweightsçŸ©é˜µï¼Œ(512, 2048)ï¼Œä»¥åŠ biasesåç§»å‘é‡, (2048)</span>
        self<span class="token punctuation">.</span>w_1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> d_ff<span class="token punctuation">)</span>
        <span class="token comment"># æ„å»ºç¬¬äºŒä¸ªå…¨è¿æ¥å±‚, (2048, 512)ï¼Œä¸¤ç§å¯è®­ç»ƒå‚æ•°ï¼šweightsçŸ©é˜µï¼Œ(2048, 512)ï¼Œä»¥åŠ biasesåç§»å‘é‡, (512)</span>
        self<span class="token punctuation">.</span>w_2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>d_ff<span class="token punctuation">,</span> d_model<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>dropout<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        (batch.size, seq.len, 512) -&gt; self.w_1 -&gt; (batch.size, seq.len, 2048)
        -&gt; relu -&gt; (batch.size, seq.len, 2048)
        -&gt; dropout -&gt; (batch.size, seq.len, 2048)
        -&gt; self.w_2 -&gt; (batch.size, seq.len, 512)
        &quot;&quot;&quot;</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>w_2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>self<span class="token punctuation">.</span>w_1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>relu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-7-embeddings-åµŒå…¥å±‚" tabindex="-1"><a class="header-anchor" href="#_6-7-embeddings-åµŒå…¥å±‚" aria-hidden="true">#</a> 6.7. Embeddingsï¼ˆåµŒå…¥å±‚ï¼‰</h3><p>å°†è¾“å…¥tokenå’Œè¾“å‡ºtokenè½¬æ¢ä¸º <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mtext>model</mtext></msub></mrow><annotation encoding="application/x-tex">d_{\text{model}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>ç»´çš„å‘é‡</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Embeddings</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> d_model<span class="token punctuation">,</span> vocab<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Embeddings<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># (vocab.len, 512)</span>
        self<span class="token punctuation">.</span>lut <span class="token operator">=</span> nn<span class="token punctuation">.</span>Embedding<span class="token punctuation">(</span>vocab<span class="token punctuation">,</span> d_model<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>d_model <span class="token operator">=</span> d_model

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># (batch.size, seq.len) -&gt; (batch.size, seq.len, 512)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>lut<span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>d_model<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-8-positionalencoding-ä½ç½®ç¼–ç " tabindex="-1"><a class="header-anchor" href="#_6-8-positionalencoding-ä½ç½®ç¼–ç " aria-hidden="true">#</a> 6.8. PositionalEncodingï¼ˆä½ç½®ç¼–ç ï¼‰</h3><p>ç”±äºæˆ‘ä»¬çš„æ¨¡å‹ä¸åŒ…å«å¾ªç¯å’Œå·ç§¯ï¼Œä¸ºäº†è®©æ¨¡å‹åˆ©ç”¨åºåˆ—çš„é¡ºåºï¼Œæˆ‘ä»¬å¿…é¡»åŠ å…¥ä¸€äº›åºåˆ—ä¸­tokençš„ç›¸å¯¹æˆ–è€…ç»å¯¹ä½ç½®çš„ä¿¡æ¯ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†â€œä½ç½®ç¼–ç â€æ·»åŠ åˆ°ç¼–ç å™¨å’Œè§£ç å™¨å †æ ˆåº•éƒ¨çš„è¾“å…¥embeddinngä¸­ã€‚ä½ç½®ç¼–ç å’Œembeddingçš„ç»´åº¦ç›¸åŒï¼Œä¹Ÿæ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mtext>model</mtext></msub></mrow><annotation encoding="application/x-tex">d_{\text{model}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> , æ‰€ä»¥è¿™ä¸¤ä¸ªå‘é‡å¯ä»¥ç›¸åŠ ã€‚</p><p>ä½¿ç”¨ä¸åŒé¢‘ç‡çš„æ­£å¼¦å’Œä½™å¼¦å‡½æ•°ï¼š</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><msub><mi>E</mi><mrow><mo stretchy="false">(</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo separator="true">,</mo><mn>2</mn><mi>i</mi><mo stretchy="false">)</mo></mrow></msub><mo>=</mo><mi>sin</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>p</mi><mi>o</mi><mi>s</mi><mi mathvariant="normal">/</mi><mn>1000</mn><msup><mn>0</mn><mrow><mn>2</mn><mi>i</mi><mi mathvariant="normal">/</mi><msub><mi>d</mi><mtext>model</mtext></msub></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex"> PE_{(pos,2i)} = \sin(pos / 10000^{2i/d_{\text{model}}}) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mop">sin</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span><span class="mord">/1000</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><msub><mi>E</mi><mrow><mo stretchy="false">(</mo><mi>p</mi><mi>o</mi><mi>s</mi><mo separator="true">,</mo><mn>2</mn><mi>i</mi><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></msub><mo>=</mo><mi>cos</mi><mo>â¡</mo><mo stretchy="false">(</mo><mi>p</mi><mi>o</mi><mi>s</mi><mi mathvariant="normal">/</mi><mn>1000</mn><msup><mn>0</mn><mrow><mn>2</mn><mi>i</mi><mi mathvariant="normal">/</mi><msub><mi>d</mi><mtext>model</mtext></msub></mrow></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex"> PE_{(pos,2i+1)} = \cos(pos / 10000^{2i/d_{\text{model}}}) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0385em;vertical-align:-0.3552em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mpunct mtight">,</span><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.188em;vertical-align:-0.25em;"></span><span class="mop">cos</span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span><span class="mord">/1000</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.938em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p><p>å…¶ä¸­ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow><annotation encoding="application/x-tex">pos</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">os</span></span></span></span> æ˜¯ä½ç½®ï¼Œ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> æ˜¯ç»´åº¦ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ç½®ç¼–ç çš„æ¯ä¸ªç»´åº¦å¯¹åº”äºä¸€ä¸ªæ­£å¼¦æ›²çº¿ã€‚ è¿™äº›æ³¢é•¿å½¢æˆä¸€ä¸ªä»<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mi>Ï€</mi></mrow><annotation encoding="application/x-tex">2\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em;">Ï€</span></span></span></span> åˆ° <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10000</mn><mo>â‹…</mo><mn>2</mn><mi>Ï€</mi></mrow><annotation encoding="application/x-tex">10000 \cdot 2\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">10000</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">â‹…</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em;">Ï€</span></span></span></span>. çš„é›†åˆçº§æ•°ã€‚ æˆ‘ä»¬é€‰æ‹©è¿™ä¸ªå‡½æ•°æ˜¯å› ä¸ºæˆ‘ä»¬å‡è®¾å®ƒä¼šè®©æ¨¡å‹å¾ˆå®¹æ˜“å­¦ä¹ å¯¹ç›¸å¯¹ä½ç½®çš„å…³æ³¨ï¼Œå› ä¸ºå¯¹ä»»æ„ç¡®å®šçš„åç§» <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>E</mi><mrow><mi>p</mi><mi>o</mi><mi>s</mi><mo>+</mo><mi>k</mi></mrow></msub></mrow><annotation encoding="application/x-tex">PE_{pos+k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span> å¯ä»¥è¡¨ç¤ºä¸º <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><msub><mi>E</mi><mrow><mi>p</mi><mi>o</mi><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">PE_{pos}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">os</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span>çš„çº¿æ€§å‡½æ•°ã€‚</p><p>æ­¤å¤–ï¼Œæˆ‘ä»¬ä¼šå°†ç¼–ç å™¨å’Œè§£ç å™¨å †æ ˆä¸­çš„embeddingå’Œä½ç½®ç¼–ç çš„å’Œå†åŠ ä¸€ä¸ªdropoutã€‚å¯¹äºåŸºæœ¬æ¨¡å‹ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„dropoutæ¯”ä¾‹æ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>d</mi><mi>r</mi><mi>o</mi><mi>p</mi></mrow></msub><mo>=</mo><mn>0.1</mn></mrow><annotation encoding="application/x-tex">P_{drop}=0.1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">ro</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0.1</span></span></span></span>.</p><p>å®ƒä½¿ç”¨æŒ‡æ•°å‡½æ•°æ¥ç”Ÿæˆä¸€ç³»åˆ—æŒ‰ä½ç½®ç¼©æ”¾çš„å€¼ã€‚è¿™äº›å€¼åç»­å°†ç”¨äºè®¡ç®—æ­£å¼¦å’Œä½™å¼¦ä½ç½®ç¼–ç ã€‚è®©æˆ‘ä»¬é€æ­¥è§£æè¿™æ®µä»£ç ï¼š torch.arange(0, d_model, 2): åˆ›å»ºä¸€ä¸ªä»0å¼€å§‹åˆ°d_modelï¼ˆä¸åŒ…æ‹¬ï¼‰çš„ä¸€ç»´å¼ é‡ï¼Œæ­¥é•¿ä¸º2ã€‚ d_modelé€šå¸¸æ˜¯Transformeræ¨¡å‹ä¸­çš„ä¸€ä¸ªå‚æ•°ï¼Œè¡¨ç¤ºç¼–ç çš„å°ºå¯¸æˆ–â€œæ·±åº¦â€ã€‚è¿™ä¸€æ­¥ç”Ÿæˆçš„åºåˆ—ç”¨äºè®¡ç®—æ¯ä¸ªç»´åº¦çš„ä½ç½®ç¼–ç çš„é¢‘ç‡ã€‚ * -(math.log(10000.0) / d_model): math.log(10000.0)è®¡ç®—10000çš„è‡ªç„¶å¯¹æ•°ã€‚ è¿™ä¸ªå€¼ä¹‹åè¢«é™¤ä»¥d_modelä»¥è·å¾—ä¸€ä¸ªç¼©æ”¾å› å­ï¼Œç„¶åä¹˜ä¸Šå‰é¢torch.arangeç”Ÿæˆçš„åºåˆ—çš„æ¯ä¸ªå…ƒç´ ã€‚ ç”±äºæœ‰ä¸€ä¸ªè´Ÿå·ï¼Œè¿™æ„å‘³ç€ç¬¦å·çš„ç¿»è½¬ã€‚æ­¤è®¡ç®—å®ç°äº†Transformerä¸­ä½ç½®ç¼–ç çš„ä¸€ä¸ªå…³é”®éƒ¨åˆ†ï¼šéšç€ç»´åº¦çš„å¢åŠ ï¼Œæ¯ä¸ªä½ç½®çš„é¢‘ç‡æŒ‰å¯¹æ•°çº§åˆ«å‡å°‘ã€‚ torch.exp(...): å¯¹ä¸Šä¸€æ­¥è®¡ç®—çš„ç»“æœåº”ç”¨æŒ‡æ•°å‡½æ•°ã€‚ç”±äºè¾“å…¥çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯è´Ÿå€¼ï¼ˆå› ä¸ºå‰é¢æœ‰è´Ÿå·ï¼‰ï¼Œè¿™ä¼šäº§ç”Ÿä¸€ç³»åˆ—åœ¨0åˆ°1ä¹‹é—´é€’å‡çš„å€¼ã€‚ è¿™äº›å€¼åœ¨è®¡ç®—æ­£å¼¦å’Œä½™å¼¦å‡½æ•°æ—¶æä¾›äº†ä¸åŒçš„æ³¢é•¿ï¼Œè¿™æ˜¯Transformeræ¨¡å‹ä¸­åˆ©ç”¨ä½ç½®ä¿¡æ¯çš„ä¸€ç§æ–¹å¼ã€‚ è½¬æ¢ä¸ºç®€å•çš„è¯æ¥è¯´ï¼Œè¿™æ®µä»£ç é€šè¿‡åœ¨ä¸åŒé¢‘ç‡ä¸Šä¸ºæ¯ä¸ªä½ç½®ç”Ÿæˆä¸åŒçš„ç¼©æ”¾å› å­ï¼Œæ¥ä¸ºTransformeræ¨¡å‹ä¸­çš„æ¯ä¸ªä½ç½®ç¼–ç ç”Ÿæˆä¸€ä¸ªåºåˆ—ã€‚ è¿™ç§åŸºäºä½ç½®çš„ç¼–ç å¸®åŠ©æ¨¡å‹ç†è§£å•è¯æˆ–æ ‡è®°ä¹‹é—´çš„ç›¸å¯¹æˆ–ç»å¯¹ä½ç½®å…³ç³»ï¼Œè¿™æ˜¯è‡ªç„¶è¯­è¨€å¤„ç†ï¼ˆNLPï¼‰ä¸­çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µã€‚ ä½ç½®ç¼–ç ä¸è¾“å…¥åµŒå…¥ç›¸åŠ åï¼Œå°±å¯ä»¥æä¾›ç»™æ¨¡å‹è¾“å…¥çš„å®Œæ•´è¡¨ç¤ºï¼ŒåŒ…å«äº†å•è¯çš„è¯­ä¹‰ä¿¡æ¯åŠå…¶åœ¨åºåˆ—ä¸­çš„ä½ç½®ä¿¡æ¯ã€‚</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">PositionalEncoding</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> d_model<span class="token punctuation">,</span> dropout<span class="token punctuation">,</span> max_len<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>PositionalEncoding<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>p<span class="token operator">=</span>dropout<span class="token punctuation">)</span>
        <span class="token comment"># äº‹å…ˆå‡†å¤‡å¥½max_len=5000çš„åºåˆ—çš„ä½ç½®ç¼–ç </span>
        <span class="token comment"># (5000,512)çŸ©é˜µï¼Œä¸€å…±5000ä¸ªä½ç½®ï¼Œæ¯ä¸ªä½ç½®ç”¨ä¸€ä¸ª512ç»´åº¦å‘é‡æ¥è¡¨ç¤ºå…¶ä½ç½®ç¼–ç </span>
        pe <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>max_len<span class="token punctuation">,</span> d_model<span class="token punctuation">)</span>
        <span class="token comment"># (5000)-&gt;(5000,1)</span>
        position <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> max_len<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># (256)</span>
        div_term <span class="token operator">=</span> torch<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> d_model<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token operator">-</span><span class="token punctuation">(</span>math<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token number">10000.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> d_model<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># å¶æ•°ä¸‹æ ‡çš„ä½ç½®,(5000,256)</span>
        pe<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>position <span class="token operator">*</span> div_term<span class="token punctuation">)</span>
        <span class="token comment"># å¥‡æ•°ä¸‹æ ‡çš„ä½ç½®,(5000,256)</span>
        pe<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>position <span class="token operator">*</span> div_term<span class="token punctuation">)</span>
        <span class="token comment"># (5000, 512) -&gt; (1, 5000, 512) ä¸ºbatch.sizeç•™å‡ºä½ç½®</span>
        pe <span class="token operator">=</span> pe<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>register_buffer<span class="token punctuation">(</span><span class="token string">&quot;pe&quot;</span><span class="token punctuation">,</span> pe<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        :param x: Embeddingsçš„è¯åµŒå…¥ç»“æœ
        :return: Embeddingsç»“æœ+ä½ç½®ç¼–ç ç»“æœ
        æ³¨æ„ï¼Œä½ç½®ç¼–ç ä¸ä¼šæ›´æ–°ï¼Œæ˜¯å†™æ­»çš„ï¼Œæ‰€ä»¥è¿™ä¸ªclassé‡Œé¢æ²¡æœ‰å¯è®­ç»ƒçš„å‚æ•°
        x.size(1)æ˜¯src.seq.len, ä»å‡†å¤‡å¥½çš„5000ä½ç½®ä¸­æˆªå–åºåˆ—é•¿åº¦çš„å¤§å°
        åœ¨å…·ä½“ç›¸åŠ çš„æ—¶å€™ï¼Œä¼šæ‰©å±•(1,src.seq.len,512)ä¸º(batch.size,src.seq.len,512)
        æ¯ä¸ªbatchä¸­çš„åºåˆ—ï¼Œéƒ½ä½¿ç”¨ä¸€æ ·çš„ä½ç½®ç¼–ç 
        &quot;&quot;&quot;</span>
        x <span class="token operator">=</span> x <span class="token operator">+</span> self<span class="token punctuation">.</span>pe<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>requires_grad_<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-9-generator-ç”Ÿæˆå™¨" tabindex="-1"><a class="header-anchor" href="#_6-9-generator-ç”Ÿæˆå™¨" aria-hidden="true">#</a> 6.9. Generatorï¼ˆç”Ÿæˆå™¨ï¼‰</h3><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Generator</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;Define standard linear + softmax generation step.&quot;
    &quot;å®šä¹‰æ ‡å‡†çš„ linear + softmax ç”Ÿæˆæ­¥éª¤ã€‚
    ä½¿ç”¨æ™®é€šçš„çº¿æ€§å˜æ¢å’Œsoftmaxå‡½æ•°å°†è§£ç å™¨è¾“å‡ºè½¬æ¢ä¸ºé¢„æµ‹çš„ä¸‹ä¸€ä¸ªtokençš„æ¦‚ç‡
    &quot;&quot;&quot;</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> d_model<span class="token punctuation">,</span> vocab<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Generator<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>proj <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>d_model<span class="token punctuation">,</span> vocab<span class="token punctuation">)</span> <span class="token comment"># çº¿æ€§æŠ•å½±å±‚ï¼Œå°†è¾“å…¥ç»´åº¦è½¬æ¢ä¸ºè¯æ±‡è¡¨ï¼ˆvocabï¼‰å¤§å°</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> log_softmax<span class="token punctuation">(</span>self<span class="token punctuation">.</span>proj<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># å¯¹çº¿æ€§æŠ•å½±ç»“æœåº”ç”¨log_softmaxå‡½æ•°ï¼Œè¿›è¡Œå½’ä¸€åŒ–å’Œæ¦‚ç‡è®¡ç®—</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>log_softmaxå‡½æ•°å°±æ˜¯å¯¹softmaxå‡½æ•°çš„æ¯ä¸ªå…ƒç´ æ±‚å¯¹æ•°æ“ä½œï¼Œä¹Ÿæ˜¯ä¸ºäº†æ¦‚ç‡å½’ä¸€åŒ–çš„æ“ä½œï¼Œå¸¸ç”¨äºç¥ç»ç½‘ç»œä¸­ï¼Œå°¤å…¶æ˜¯æ³¨æ„åŠ›æœºåˆ¶ä¸­æ¦‚ç‡å¾—åˆ†çš„è®¡ç®—ã€‚ç”±äº softmax å¾—åˆ°çš„æ¦‚ç‡åˆ†å¸ƒå’Œ log_softmax å¾—åˆ°çš„æ¦‚ç‡åˆ†å¸ƒå¯ä»¥ç›¸åŠ å‡ï¼Œå› æ­¤å°†åŸå§‹åˆ†æ•°è½¬æ¢ä¸ºå¯¹æ•°å½¢å¼å¯ä»¥é¿å…æº¢å‡ºï¼Œå¹¶ä¸”æ›´å®¹æ˜“è®¡ç®—æ¦‚ç‡ä¹˜æ³•ã€‚LogSoftmaxç›¸å¯¹äºSoftmaxçš„ä¼˜åŠ¿åœ¨äºå¯¹æ•°è¿ç®—æ—¶æ±‚å¯¼æ›´å®¹æ˜“ï¼ŒåŠ å¿«äº†åå‘ä¼ æ’­çš„é€Ÿåº¦ã€‚è§£å†³Softmaxå¯èƒ½å­˜åœ¨çš„ä¸Šæº¢å’Œä¸‹æº¢çš„é—®é¢˜ã€‚</p><h3 id="_6-10-clones-å…‹éš†" tabindex="-1"><a class="header-anchor" href="#_6-10-clones-å…‹éš†" aria-hidden="true">#</a> 6.10. clonesï¼ˆå…‹éš†ï¼‰</h3><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">clones</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">&quot;Produce N identical layers.&quot;</span>
    <span class="token string">&quot;å¤åˆ¶nä¸ªç›¸åŒçš„å±‚&quot;</span>
    <span class="token keyword">return</span> nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">[</span>copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>module<span class="token punctuation">)</span> <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-11-layernorm-å±‚å½’ä¸€åŒ–" tabindex="-1"><a class="header-anchor" href="#_6-11-layernorm-å±‚å½’ä¸€åŒ–" aria-hidden="true">#</a> 6.11. LayerNormï¼ˆå±‚å½’ä¸€åŒ–ï¼‰</h3><p>è¿™æ®µä»£ç å®ç°äº†ä¸€ä¸ªç®€å•çš„ Layer Normalization æ¨¡å—ï¼šåœ¨ init æ–¹æ³•ä¸­ï¼Œå®ƒæ¥å—ä¸€ä¸ªæ•´æ•° features å’Œä¸€ä¸ªå°çš„å¸¸æ•° eps (eps=1e-6)ä½œä¸ºå‚æ•°ã€‚å®ƒé¦–å…ˆè°ƒç”¨ nn.Module çš„æ„é€ å‡½æ•°æ¥åˆå§‹åŒ–çˆ¶ç±»ã€‚ç„¶åï¼Œå®ƒåˆ›å»ºäº†ä¸¤ä¸ªå¯å­¦ä¹ çš„å‚æ•° a_2 å’Œ b_2ï¼Œåˆ†åˆ«ç”¨äºç¼©æ”¾å’Œå¹³ç§»æ“ä½œã€‚è¿™äº›å‚æ•°çš„å½¢çŠ¶ä¸º (features,)ï¼Œå…¶ä¸­ features æ˜¯è¾“å…¥å¼ é‡çš„æœ€åä¸€ä¸ªç»´åº¦çš„å¤§å°ã€‚æœ€åï¼Œå®ƒå°† eps å­˜å‚¨åœ¨å®ä¾‹å˜é‡ self.eps ä¸­ã€‚åœ¨ forward æ–¹æ³•ä¸­ï¼Œå®ƒæ¥å—è¾“å…¥å¼ é‡ x ä½œä¸ºå‚æ•°ã€‚å®ƒé¦–å…ˆè®¡ç®— x åœ¨æœ€åä¸€ä¸ªç»´åº¦ä¸Šçš„å‡å€¼ mean å’Œæ ‡å‡†å·® stdã€‚ç„¶åï¼Œå®ƒä½¿ç”¨è¿™äº›ç»Ÿè®¡é‡å¯¹ x è¿›è¡Œ Layer Normalizationï¼Œå³å°† x å‡å»å‡å€¼å¹¶é™¤ä»¥æ ‡å‡†å·®ã€‚æœ€åï¼Œå®ƒå°†ç¼©æ”¾å‚æ•° a_2 ä¹˜ä»¥å½’ä¸€åŒ–åçš„ç»“æœï¼Œå¹¶åŠ ä¸Šå¹³ç§»å‚æ•° b_2ï¼Œå¾—åˆ°æœ€ç»ˆçš„è¾“å‡ºã€‚</p><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">LayerNorm</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">&quot;Construct a layernorm module (See citation for details).&quot;</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> features<span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">1e-6</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># featuresæ˜¯ä¸€ä¸ªæ•´æ•°</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>LayerNorm<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>a_2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>features<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>b_2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>features<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>eps <span class="token operator">=</span> eps

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        mean <span class="token operator">=</span> x<span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        std <span class="token operator">=</span> x<span class="token punctuation">.</span>std<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> keepdim<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>a_2 <span class="token operator">*</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> mean<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>std <span class="token operator">+</span> self<span class="token punctuation">.</span>eps<span class="token punctuation">)</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>b_2
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-12-sublayerconnection-å­å±‚è¿æ¥" tabindex="-1"><a class="header-anchor" href="#_6-12-sublayerconnection-å­å±‚è¿æ¥" aria-hidden="true">#</a> 6.12. SublayerConnectionï¼ˆå­å±‚è¿æ¥ï¼‰</h3><p>æ¯ä¸ªå­å±‚çš„è¾“å‡ºæ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">L</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">N</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">m</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo>+</mo><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{LayerNorm}(x + \mathrm{Sublayer}(x))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathrm">LayerNorm</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathrm">Sublayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">))</span></span></span></span>, å…¶ä¸­ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mi mathvariant="normal">S</mi><mi mathvariant="normal">u</mi><mi mathvariant="normal">b</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">y</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">r</mi></mrow><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathrm{Sublayer}(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathrm">Sublayer</span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> æ˜¯å­å±‚æœ¬èº«å®ç°çš„å‡½æ•°ã€‚æˆ‘ä»¬å°† dropoutï¼ˆDropout: A Simple Way to Prevent Neural Networks from Overfittingï¼ŒThe key idea is to randomly drop units (along with their connections) from the neural network during training.ï¼‰ åº”ç”¨äºæ¯ä¸ªå­å±‚çš„è¾“å‡ºï¼Œç„¶åå†å°†å…¶æ·»åŠ åˆ°å­å±‚è¾“å…¥ä¸­å¹¶è¿›è¡Œå½’ä¸€åŒ–ã€‚ ä¸ºäº†ä¾¿äºè¿›è¡Œæ®‹å·®è¿æ¥ï¼ˆresidual connectionsï¼‰ï¼Œæ¨¡å‹ä¸­çš„æ‰€æœ‰å­å±‚ä»¥åŠembeddingå±‚äº§ç”Ÿçš„è¾“å‡ºçš„ç»´åº¦éƒ½ä¸º<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mtext>model</mtext></msub><mo>=</mo><mn>512</mn></mrow><annotation encoding="application/x-tex">d_{\text{model}}=512</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">model</span></span></span></span></span></span><span class="vlist-s">â€‹</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">512</span></span></span></span>.</p><blockquote><p>åœ¨æ®‹å·®è¿æ¥ä¸­ï¼Œè¾“å…¥é€šè¿‡ä¸€ä¸ªè·¨å±‚è¿æ¥ï¼ˆshortcut connectionï¼‰ç›´æ¥æ·»åŠ åˆ°å±‚çš„dropoutåçš„è¾“å‡ºä¸Š(x + self.dropout(sublayer(self.norm(x))))ã€‚ä¸ºäº†ä¿æŒç»´åº¦ä¸€è‡´æ€§ï¼Œå¯ä»¥åœ¨æ®‹å·®è¿æ¥ä¸­åº”ç”¨ Layer Normalizationã€‚è¿™æ ·å¯ä»¥ç¡®ä¿æ®‹å·®è¿æ¥ä¸­çš„è¾“å…¥å’Œè¾“å‡ºéƒ½ç»è¿‡äº†ç›¸åŒçš„å½’ä¸€åŒ–å¤„ç†ï¼Œä»è€Œæé«˜ç½‘ç»œçš„è®­ç»ƒæ•ˆæœå’Œæ€§èƒ½ã€‚</p></blockquote><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">SublayerConnection</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    A residual connection followed by a layer norm.
    Note for code simplicity the norm is first as opposed to last.

    ä¸€ä¸ªæ®‹å·®è¿æ¥ï¼ˆresidual connectionï¼‰åè·Ÿä¸€ä¸ªå±‚å½’ä¸€åŒ–ï¼ˆLayerNormï¼‰
    ä¸ºäº†ä»£ç çš„ç®€æ´æ€§ï¼Œå°†å±‚å½’ä¸€åŒ–æ”¾åœ¨æ®‹å·®è¿æ¥ä¹‹å‰
    &quot;&quot;&quot;</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> size<span class="token punctuation">,</span> dropout<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># size=d_model=512; dropout=0.1</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>SublayerConnection<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>norm <span class="token operator">=</span> LayerNorm<span class="token punctuation">(</span>size<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>dropout<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">,</span> sublayer<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">&quot;&quot;&quot;
        Apply residual connection to any sublayer with the same size.
        åº”ç”¨æ®‹å·®è¿æ¥å’Œå±‚å½’ä¸€åŒ–ï¼Œè¿”å›æœ€ç»ˆçš„è¾“å‡ºï¼Œå°†æ®‹å·®è¿æ¥åº”ç”¨äºå…·æœ‰ç›¸åŒå¤§å°çš„ä»»ä½•å­å±‚ã€‚
        x (batch.size, seq.len, 512)
        sublayer æ˜¯ä¸€ä¸ªå…·ä½“çš„ MultiHeadAttention æˆ–è€… Position-wise FeedForward å¯¹è±¡çš„ç»“æœ

        x (batch.size, seq.len, 512) -&gt; norm (LayerNorm) -&gt; (batch.size, seq.len, 512)
        -&gt; sublayer (MultiHeadAttention or PositionwiseFeedForward, å­å±‚ä¼ å…¥çš„xæ˜¯å±‚å½’ä¸€åŒ–åçš„x)
        -&gt; (batch.size, seq.len, 512) -&gt; dropout -&gt; (batch.size, seq.len, 512)

        ç„¶åè¾“å…¥çš„xï¼ˆæ²¡æœ‰èµ°sublayer) + ä¸Šé¢çš„ç»“æœï¼Œå³å®ç°äº†æ®‹å·®ç›¸åŠ çš„åŠŸèƒ½
        &quot;&quot;&quot;</span>
        <span class="token keyword">return</span> x <span class="token operator">+</span> self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>sublayer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-13-æ¨¡å‹ä½¿ç”¨çš„ä¾‹å­" tabindex="-1"><a class="header-anchor" href="#_6-13-æ¨¡å‹ä½¿ç”¨çš„ä¾‹å­" aria-hidden="true">#</a> 6.13. æ¨¡å‹ä½¿ç”¨çš„ä¾‹å­</h3><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&#39;__main__&#39;</span><span class="token punctuation">:</span>
    flag <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">if</span> flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token comment"># å‡è®¾è‹±è¯­è¯æ±‡è¡¨å¤§å°ä¸º10000ï¼Œä¸­æ–‡è¯æ±‡è¡¨å¤§å°ä¸º15000</span>
        src_vocab_size <span class="token operator">=</span> <span class="token number">10000</span>
        tgt_vocab_size <span class="token operator">=</span> <span class="token number">15000</span>

        src <span class="token operator">=</span> torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># åˆ›å»ºè¾“å…¥åºåˆ—å¼ é‡</span>
        src_mask <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token comment"># åˆ›å»ºè¾“å…¥åºåˆ—çš„æ©ç å¼ é‡</span>
        ys <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>src<span class="token punctuation">)</span>  <span class="token comment"># åˆ›å»ºåˆå§‹è¾“å‡ºåºåˆ—å¼ é‡</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>ys<span class="token punctuation">)</span>
        test_model <span class="token operator">=</span> make_model<span class="token punctuation">(</span>src_vocab_size<span class="token punctuation">,</span> tgt_vocab_size<span class="token punctuation">)</span> <span class="token comment"># åˆ›å»ºä¸€ä¸ªæ¨¡å‹å®ä¾‹</span>
        test_model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># å°†æ¨¡å‹è®¾ç½®ä¸ºè¯„ä¼°æ¨¡å¼</span>
        memory <span class="token operator">=</span> test_model<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>src<span class="token punctuation">,</span> src_mask<span class="token punctuation">)</span> <span class="token comment"># ç¼–ç è¾“å…¥åºåˆ—ï¼Œå¾—åˆ°è®°å¿†å¼ é‡</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#39;src:</span><span class="token interpolation"><span class="token punctuation">{</span>src<span class="token punctuation">.</span>shape<span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#39;memory:</span><span class="token interpolation"><span class="token punctuation">{</span>memory<span class="token punctuation">.</span>shape<span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#39;ys:</span><span class="token interpolation"><span class="token punctuation">{</span>ys<span class="token punctuation">.</span>shape<span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>ys<span class="token punctuation">)</span>
            t <span class="token operator">=</span> subsequent_mask<span class="token punctuation">(</span>ys<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>src<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
            out <span class="token operator">=</span> test_model<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>
                memory<span class="token punctuation">,</span> src_mask<span class="token punctuation">,</span> ys<span class="token punctuation">,</span> subsequent_mask<span class="token punctuation">(</span>ys<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>src<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>  <span class="token comment"># è§£ç è¾“å‡ºåºåˆ—</span>
            t <span class="token operator">=</span> out<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f&#39;out:</span><span class="token interpolation"><span class="token punctuation">{</span>out<span class="token punctuation">.</span>shape<span class="token punctuation">}</span></span><span class="token string">,generatorçš„å…¥å‚ï¼š</span><span class="token interpolation"><span class="token punctuation">{</span>t<span class="token punctuation">.</span>shape<span class="token punctuation">}</span></span><span class="token string">&#39;</span></span><span class="token punctuation">)</span>
            prob <span class="token operator">=</span> test_model<span class="token punctuation">.</span>generator<span class="token punctuation">(</span>out<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># é€šè¿‡ç”Ÿæˆå™¨è·å¾—ä¸‹ä¸€ä¸ªè¯çš„æ¦‚ç‡åˆ†å¸ƒ</span>
            _<span class="token punctuation">,</span> next_word <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>prob<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># é€‰æ‹©æ¦‚ç‡æœ€é«˜çš„ä¸‹ä¸€ä¸ªè¯</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;æœ€é«˜æ¦‚ç‡çš„ä¸‹ä¸€ä¸ªè¯:&quot;</span><span class="token punctuation">,</span> next_word<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># æ‰“å°æœ€é«˜æ¦‚ç‡çš„ä¸‹ä¸€ä¸ªè¯çš„ç´¢å¼•</span>
            next_word <span class="token operator">=</span> next_word<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># è·å–ä¸‹ä¸€ä¸ªè¯çš„ç´¢å¼•</span>
            ys <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>
                    <span class="token punctuation">[</span>ys<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>src<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>fill_<span class="token punctuation">(</span>next_word<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span>
                <span class="token punctuation">)</span>  <span class="token comment"># å°†ä¸‹ä¸€ä¸ªè¯æ·»åŠ åˆ°è¾“å‡ºåºåˆ—ä¸­</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;æœªç»è®­ç»ƒçš„é¢„æµ‹ç»“æœ:&quot;</span><span class="token punctuation">,</span> ys<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        V <span class="token operator">=</span> <span class="token number">11</span>
        batch_size <span class="token operator">=</span> <span class="token number">80</span>
        data_iter <span class="token operator">=</span> data_gen<span class="token punctuation">(</span>V<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>

        model <span class="token operator">=</span> make_model<span class="token punctuation">(</span>V<span class="token punctuation">,</span> V<span class="token punctuation">)</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> batch <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># ä½¿ç”¨æ¨¡å‹è¿›è¡Œå‰å‘ä¼ æ’­</span>
            out <span class="token operator">=</span> model<span class="token punctuation">.</span>forward<span class="token punctuation">(</span>
                batch<span class="token punctuation">.</span>src<span class="token punctuation">,</span> batch<span class="token punctuation">.</span>tgt<span class="token punctuation">,</span> batch<span class="token punctuation">.</span>src_mask<span class="token punctuation">,</span> batch<span class="token punctuation">.</span>tgt_mask
            <span class="token punctuation">)</span>
            <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>out<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">subsequent_mask</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    Mask out subsequent positions. 
    å±è”½åç»­ä½ç½®çš„æ³¨æ„åŠ›
    åœ¨è®­ç»ƒæ—¶å°†å½“å‰å•è¯çš„æœªæ¥ä¿¡æ¯å±è”½æ‰ï¼Œé˜»æ­¢æ­¤å•è¯å…³æ³¨åˆ°åé¢çš„å•è¯ã€‚

    é˜²æ­¢åœ¨å½“å‰ä½ç½®å…³æ³¨åˆ°åé¢çš„ä½ç½®ã€‚è¿™ç§æ©ç ç»“åˆå°†è¾“å‡ºembeddingåç§»ä¸€ä¸ªä½ç½®ï¼Œç¡®ä¿å¯¹ä½ç½®içš„é¢„æµ‹åªä¾èµ–ä½ç½®iä¹‹å‰çš„å·²çŸ¥è¾“å‡ºã€‚
    &quot;&quot;&quot;</span>
    <span class="token comment"># æ³¨æ„åŠ›çŸ©é˜µçš„å½¢çŠ¶</span>
    attn_shape <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> size<span class="token punctuation">)</span>
    <span class="token comment"># åˆ›å»ºä¸Šä¸‰è§’çŸ©é˜µ</span>
    subsequent_mask <span class="token operator">=</span> torch<span class="token punctuation">.</span>triu<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>attn_shape<span class="token punctuation">)</span><span class="token punctuation">,</span> diagonal<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>
        torch<span class="token punctuation">.</span>uint8
    <span class="token punctuation">)</span>
    <span class="token keyword">return</span> subsequent_mask <span class="token operator">==</span> <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Batch</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    æ‰¹å¤„ç†å’Œæ©ç 
    ç”¨äºåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¿å­˜ä¸€ä¸ªæ•°æ®æ‰¹æ¬¡åŠå…¶æ©ç çš„å¯¹è±¡ã€‚
    &quot;&quot;&quot;</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> src<span class="token punctuation">,</span> tgt<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> pad<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 2 = &lt;blank&gt;ï¼Œç”¨äºæŒ‡å®šå¡«å……æ ‡è®°çš„ç´¢å¼•</span>
        <span class="token comment"># src: æºè¯­è¨€åºåˆ—ï¼Œ(batch.size, src.seq.len)</span>
        <span class="token comment"># äºŒç»´tensorï¼Œç¬¬ä¸€ç»´åº¦æ˜¯batch.sizeï¼›ç¬¬äºŒä¸ªç»´åº¦æ˜¯æºè¯­è¨€å¥å­çš„é•¿åº¦</span>
        <span class="token comment"># ä¾‹å¦‚ï¼š[ [2,1,3,4], [2,3,1,4] ]è¿™æ ·çš„äºŒè¡Œå››åˆ—çš„ï¼Œ</span>
        <span class="token comment"># 1-4ä»£è¡¨æ¯ä¸ªå•è¯wordçš„id</span>
        
        <span class="token comment"># tgt: ç›®æ ‡è¯­è¨€åºåˆ—ï¼Œé»˜è®¤ä¸ºç©ºï¼Œå…¶shapeå’Œsrcç±»ä¼¼</span>
        <span class="token comment"># (batch.size, tgt.seq.len)ï¼Œ</span>
        <span class="token comment"># äºŒç»´tensorï¼Œç¬¬ä¸€ç»´åº¦æ˜¯batch.sizeï¼›ç¬¬äºŒä¸ªç»´åº¦æ˜¯ç›®æ ‡è¯­è¨€å¥å­çš„é•¿åº¦</span>
        <span class="token comment"># ä¾‹å¦‚tgt=[ [2,1,3,4], [2,3,1,4] ] for a &quot;copy network&quot;</span>
        <span class="token comment"># (è¾“å‡ºåºåˆ—å’Œè¾“å…¥åºåˆ—å®Œå…¨ç›¸åŒï¼‰</span>
        
        <span class="token comment"># pad: æºè¯­è¨€å’Œç›®æ ‡è¯­è¨€ç»Ÿä¸€ä½¿ç”¨çš„ ä½ç½®å¡«å……ç¬¦å·ï¼Œ&#39;&lt;blank&gt;&#39;</span>
        <span class="token comment"># æ‰€å¯¹åº”çš„idï¼Œè¿™é‡Œé»˜è®¤ä¸º0</span>
        <span class="token comment"># ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªsource sequenceï¼Œé•¿åº¦ä¸åˆ°4ï¼Œåˆ™åœ¨å³è¾¹è¡¥0</span>
        <span class="token comment"># [1,2] -&gt; [1,2,0,0]</span>
        self<span class="token punctuation">.</span>src <span class="token operator">=</span> src  <span class="token comment"># æºåºåˆ—å¼ é‡</span>
        <span class="token comment"># åœ¨æ³¨æ„åŠ›æœºåˆ¶çš„è®¡ç®—ä¸­ï¼Œè¿™ä¸ªæ©ç å¯ä»¥ç”¨æ¥ç¡®ä¿æ¨¡å‹ä¸ä¼šè€ƒè™‘åˆ°å¡«å……ä½ç½®çš„å…ƒç´ ï¼Œ</span>
        <span class="token comment"># å³é€šè¿‡è®©å¡«å……ä½ç½®çš„æ³¨æ„åŠ›æƒé‡æ¥è¿‘äºé›¶æˆ–å®é™…ä¸Šä¸ºé›¶ã€‚</span>
        <span class="token comment"># è¿™æ ·å¤„ç†ï¼Œæ¨¡å‹å°±åªä¼šåœ¨éå¡«å……çš„å…ƒç´ ä¸Šè®¡ç®—æ³¨æ„åŠ›ï¼Œä»è€Œé¿å…å¡«å……å€¼å¹²æ‰°æ¨¡å‹ç†è§£å’Œå¤„ç†åºåˆ—çš„èƒ½åŠ›ã€‚</span>
        self<span class="token punctuation">.</span>src_mask <span class="token operator">=</span> <span class="token punctuation">(</span>src <span class="token operator">!=</span> pad<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># æºåºåˆ—çš„æ©ç å¼ é‡ï¼Œç”¨äºé®ç›–å¡«å……ä½ç½®</span>
        <span class="token comment"># src = (batch.size, seq.len) -&gt; != pad -&gt; </span>
        <span class="token comment"># (batch.size, seq.len) -&gt; usnqueeze -&gt;</span>
        <span class="token comment"># (batch.size, 1, seq.len) ç›¸å½“äºåœ¨å€’æ•°ç¬¬äºŒä¸ªç»´åº¦æ‰©å±•</span>
        <span class="token comment"># e.g., src=[ [2,1,3,4], [2,3,1,4] ]å¯¹åº”çš„æ˜¯</span>
        <span class="token comment"># src_mask=[ [[1,1,1,1], [1,1,1,1]] ]</span>
        <span class="token keyword">if</span> tgt <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>tgt <span class="token operator">=</span> tgt<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># ç›®æ ‡åºåˆ—å¼ é‡ï¼Œå»é™¤æœ€åä¸€ä¸ªä½ç½®çš„æ ‡è®°</span>
            <span class="token comment"># tgt ç›¸å½“äºç›®æ ‡åºåˆ—çš„å‰N-1ä¸ªå•è¯çš„åºåˆ—</span>
            <span class="token comment">#ï¼ˆå»æ‰äº†æœ€åä¸€ä¸ªè¯ï¼‰</span>
            self<span class="token punctuation">.</span>tgt_y <span class="token operator">=</span> tgt<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># ç›®æ ‡åºåˆ—å¼ é‡çš„ä¸‹ä¸€ä¸ªä½ç½®çš„æ ‡è®°</span>
            <span class="token comment"># tgt_y ç›¸å½“äºç›®æ ‡åºåˆ—çš„åN-1ä¸ªå•è¯çš„åºåˆ—</span>
            <span class="token comment"># (å»æ‰äº†ç¬¬ä¸€ä¸ªè¯ï¼‰</span>
            <span class="token comment"># ç›®çš„æ˜¯(src + tgt) æ¥é¢„æµ‹å‡ºæ¥(tgt_y)ï¼Œ</span>
            self<span class="token punctuation">.</span>tgt_mask <span class="token operator">=</span> self<span class="token punctuation">.</span>make_std_mask<span class="token punctuation">(</span>self<span class="token punctuation">.</span>tgt<span class="token punctuation">,</span> pad<span class="token punctuation">)</span>  <span class="token comment"># ç›®æ ‡åºåˆ—çš„æ©ç å¼ é‡ï¼Œç”¨äºé®ç›–å¡«å……ä½ç½®å’Œæœªæ¥ä½ç½®</span>
            self<span class="token punctuation">.</span>ntokens <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>tgt_y <span class="token operator">!=</span> pad<span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># ç›®æ ‡åºåˆ—ä¸­éå¡«å……æ ‡è®°çš„æ•°é‡</span>

    <span class="token decorator annotation punctuation">@staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">make_std_mask</span><span class="token punctuation">(</span>tgt<span class="token punctuation">,</span> pad<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token string">&quot;åˆ›å»ºä¸€ä¸ªæ©ç ï¼Œç”¨äºéšè—å¡«å……ä½ç½®å’Œæœªæ¥çš„è¯ã€‚&quot;</span>
        <span class="token comment"># è¿™é‡Œçš„tgtç±»ä¼¼äºï¼š</span>
        <span class="token comment">#[ [2,1,3], [2,3,1] ] ï¼ˆæœ€åˆçš„è¾“å…¥ç›®æ ‡åºåˆ—ï¼Œåˆ†åˆ«å»æ‰äº†æœ€åä¸€ä¸ªè¯</span>
        <span class="token comment"># pad=0, &#39;&lt;blank&gt;&#39;çš„idç¼–å·</span>
        tgt_mask <span class="token operator">=</span> <span class="token punctuation">(</span>tgt <span class="token operator">!=</span> pad<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># åˆ›å»ºä¸€ä¸ªæ©ç å¼ é‡ï¼Œç”¨äºé®ç›–å¡«å……ä½ç½®</span>
        <span class="token comment"># å¾—åˆ°çš„tgt_maskç±»ä¼¼äº</span>
        <span class="token comment"># tgt_mask = tensor([[[1, 1, 1]],[[1, 1, 1]]], dtype=torch.uint8)</span>
        <span class="token comment"># shape=(2,1,3)</span>
        tgt_mask <span class="token operator">=</span> tgt_mask <span class="token operator">&amp;</span> subsequent_mask<span class="token punctuation">(</span>tgt<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>
            tgt_mask<span class="token punctuation">.</span>data
        <span class="token punctuation">)</span>  <span class="token comment"># ä¸ä¸€ä¸ªç”¨äºé®ç›–æœªæ¥ä½ç½®çš„æ©ç å¼ é‡ç›¸ä¸ï¼Œä»¥å¾—åˆ°æœ€ç»ˆçš„ç›®æ ‡åºåˆ—æ©ç å¼ é‡</span>
        <span class="token comment"># å…ˆçœ‹subsequent_mask, å…¶è¾“å…¥çš„æ˜¯tgt.size(-1)=3</span>
        <span class="token comment"># è¿™ä¸ªå‡½æ•°çš„è¾“å‡ºä¸º= tensor([[[1, 0, 0],</span>
        <span class="token comment"># [1, 1, 0],</span>
        <span class="token comment"># [1, 1, 1]]], dtype=torch.uint8)</span>
        <span class="token comment"># type_as æŠŠè¿™ä¸ªtensorè½¬æˆtgt_mask.dataçš„type(ä¹Ÿæ˜¯torch.uint8)</span>
        
        <span class="token comment"># è¿™æ ·çš„è¯ï¼Œ&amp;çš„ä¸¤è¾¹çš„tensorå½¢çŠ¶åˆ†åˆ«æ˜¯(2,1,3) &amp; (1,3,3) è¿›è¡Œä¸æ“ä½œä¹‹åå¾—åˆ°å½¢çŠ¶ï¼ˆ2ï¼Œ3ï¼Œ3ï¼‰çš„ç»“æœ</span>
        <span class="token comment">#tgt_mask = tensor([[[1, 1, 1]],[[1, 1, 1]]], dtype=torch.uint8)</span>
        <span class="token comment">#and</span>
        <span class="token comment"># tensor([[[1, 0, 0], [1, 1, 0], [1, 1, 1]]], dtype=torch.uint8)</span>
        
        <span class="token comment"># å½¢çŠ¶(2,3,3)å°±æ˜¯å¾—åˆ°çš„tensor</span>
        <span class="token comment"># tgt_mask.data = tensor([[[1, 0, 0],</span>
        <span class="token comment"># [1, 1, 0],</span>
        <span class="token comment"># [1, 1, 1]],</span>

        <span class="token comment">#[[1, 0, 0],</span>
        <span class="token comment"># [1, 1, 0],</span>
        <span class="token comment"># [1, 1, 1]]], dtype=torch.uint8)</span>
        <span class="token keyword">return</span> tgt_mask
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-ext="py"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">data_gen</span><span class="token punctuation">(</span>V<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> nbatches<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">&quot;Generate random data for a src-tgt copy task. åˆæˆæ•°æ®&quot;</span>
    <span class="token triple-quoted-string string">&quot;&quot;&quot;
    å°è¯•ä¸€ä¸ªç®€å•çš„å¤åˆ¶ä»»åŠ¡å¼€å§‹ã€‚ç»™å®šæ¥è‡ªå°è¯æ±‡è¡¨çš„ä¸€ç»„éšæœºè¾“å…¥ç¬¦å·symbolsï¼Œç›®æ ‡æ˜¯ç”Ÿæˆè¿™äº›ç›¸åŒçš„ç¬¦å·
    &quot;&quot;&quot;</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>nbatches<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> torch<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> V<span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        data<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
        src <span class="token operator">=</span> data<span class="token punctuation">.</span>requires_grad_<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>
        tgt <span class="token operator">=</span> data<span class="token punctuation">.</span>requires_grad_<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">yield</span> Batch<span class="token punctuation">(</span>src<span class="token punctuation">,</span> tgt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!--[--><!----><!--]--><footer class="page-meta"><!----><div class="meta-item git-info"><!----><!----></div></footer><nav class="vp-page-nav"><a aria-label="streamlitæ„å»ºå¯¹è¯å¼åº”ç”¨ç¨‹åº" class="vp-link nav-link prev nav-link prev" href="/blog/zh/posts/LLM/streamlit.html"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><span class="font-icon icon fa-fw fa-sm fas fa-lightbulb" style=""></span>streamlitæ„å»ºå¯¹è¯å¼åº”ç”¨ç¨‹åº</div></a><a aria-label="Llamaæºç è§£è¯»" class="vp-link nav-link next nav-link next" href="/blog/zh/posts/LLM/llama.html"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">Llamaæºç è§£è¯»<span class="font-icon icon fa-fw fa-sm fas fa-lightbulb" style=""></span></div></a></nav><!----><!--[--><!----><!--]--><!--]--></main><!--]--><!----></div><!--]--><!--]--><!----><!--]--></div>
    <script type="module" src="/blog/assets/app-qHU6L02m.js" defer></script>
  </body>
</html>
